<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
    <title>Hyperion - x3ero0&#39;s blog</title>

    <style type="text/css">
        img.wp-smiley,
        img.emoji {
            display: inline !important;
            border: none !important;
            box-shadow: none !important;
            height: 1em !important;
            width: 1em !important;
            margin: 0 .07em !important;
            vertical-align: -0.1em !important;
            background: none !important;
            padding: 0 !important;
        }
    </style>
    <link rel='stylesheet' href='/css/style.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/custom.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/syntax.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/toc.css' type='text/css' media='all' />
    
    <meta property="og:title" content="Hyperion" />
<meta property="og:description" content="Pwning Pocket Tanks - Hyperion [Google CTF 2017 Finals]   Author : Gynvael Coldwind Language : C/C&#43;&#43; Upload : May 9th, 2018 Level : I will rate it 8/10 Platform : Server: Linux | Client: Windows/Linux etc. Files : change the link hyperion  Desc:- It&#39;s 2017, so even single-player games require Internet connection. Hyperion was one of the pwn challenges from Google CTF 2017 Finals. One day I randomly asked Gynvael (who is the author of this challenge) to give me some CTF challenges." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://x3ero0.github.io/posts/hyperion/" />
<meta property="article:published_time" content="2021-03-26T12:13:38+05:30" />
<meta property="article:modified_time" content="2021-03-26T12:13:38+05:30" />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hyperion"/>
<meta name="twitter:description" content="Pwning Pocket Tanks - Hyperion [Google CTF 2017 Finals]   Author : Gynvael Coldwind Language : C/C&#43;&#43; Upload : May 9th, 2018 Level : I will rate it 8/10 Platform : Server: Linux | Client: Windows/Linux etc. Files : change the link hyperion  Desc:- It&#39;s 2017, so even single-player games require Internet connection. Hyperion was one of the pwn challenges from Google CTF 2017 Finals. One day I randomly asked Gynvael (who is the author of this challenge) to give me some CTF challenges."/>

</head>

    <body class="two-column">
        <a href="#content">Skip to content</a>
<div class="wrapper">
    <header role="banner" class="banner widgets columns-1">
        <a href="/" rel="home">
            <h1 class="site">x3ero0&#39;s blog</h1>
            <p></p>
        </a>
        <nav role="navigation" aria-label="Primary Navigation">

            <ul class="menu">
                <li class="menu-item "><a class="menu__link" href="/about/">ABOUT</a></li>
            </ul>
            <select onChange="location.href=value;">
                <option value="/about/" class="menu-item menu-item-type-custom menu-item-object-custom" >ABOUT</option>
            </select>
        </nav>
    </header>

    <br>
    <div style="width: 100%; max-height: 100px; text-align: center;">
       
</div>

    <div class="breadcrumbs">
        
    </div>
        <div id="content" class="content">

<main role="main">
    <article role="article" class="post type-post format-standard hentry">
        <header class="post-header">
            <h1>Hyperion</h1>
            <div class="post-details">
                <a rel="bookmark">
                    <time datetime="2021-03-26T326:1213:386">2021-03-26</time>
                </a>
				
<span style="float: right;">
    <div id="fb-root" style="height: 100%;"></div>
    
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
    
    <div class="fb-share-button" data-href="https://x3ero0.github.io/posts/hyperion/" data-layout="button_count" data-size="small">
        <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fx3ero0.github.io%2fposts%2fhyperion%2f" class="fb-xfbml-parse-ignore">Share</a>
    </div>
    &nbsp;
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="Hyperion" data-url="https://x3ero0.github.io/posts/hyperion/" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    &nbsp;
    
</span>

            </div>
        </header>

        <div class="post-content">
            

<link href="/css/prism.css" rel="stylesheet"/>

<h1 id="pwning-pocket-tanks---hyperion-google-ctf-2017-finals">Pwning Pocket Tanks - Hyperion [Google CTF 2017 Finals]</h1>
<hr>
<ul>
<li>Author : <a href="https://gynvael.coldwind.pl/">Gynvael Coldwind</a></li>
<li>Language : C/C++</li>
<li>Upload : May 9th, 2018</li>
<li>Level : I will rate it 8/10</li>
<li>Platform : Server: Linux | Client: Windows/Linux etc.</li>
<li>Files : <a href="https://crackmes.one/crackme/5bc0fe0033c5d4110a29b296">change the link hyperion</a></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Desc:
  - It&#39;s 2017, so even single-player games require Internet connection.
</code></pre></div><hr>


<br>

<p>Hyperion was one of the pwn challenges from Google CTF 2017 Finals. One day I randomly asked Gynvael (who is the author of this challenge) to give me some CTF challenges. He gave me 3 Revs and 1 Pwn challenges. In the end i solved 2 Revs and 1 Pwn.  I received these challenges in June 2019, but being a noob i was not able to solve any of them. I solved the 2 Revs (the 3rd Rev is still unsolved and i still have no clue XD) sometime in 2020 but this Pwn (Hyperion) was still remaining. Just recently i decided that i will take a look and i will solve it finally.</p>
<h3 id="first-look">First Look</h3>
<hr>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/game.png"
    alt="First look of the Challenge"
    decoding="async"
  />
</div>


<br>

<p>Hyperion is a single player clone of Pocket Tanks, except that it requires internet connection even when playing againts a bot. We are given a server binary that runs on Linux and 2 Version of client, one for windows and one for linux. The client binaries requires SDL2 because the game uses SDL for graphics and controls.</p>
<p>The Goal of this challenge is to not only defeat the bot, but to also get a shell on the server. I immediately opened the server binary in IDA Pro.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/main.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>The challenge pops shell if its running in DEBUG environment with &ldquo;HYPERION_ENV_TEST&rdquo; environment variable set. Game also supports fork server mode and single run mode.</p>
<p>I used the single run mode so that i can the interaction happens through <code>STDIN</code> and <code>STDOUT</code>.</p>
<p><code>socat TCP-LISTEN:1337,reuseaddr,fork exec:./hyperion_server</code></p>
<p>Now we can connect to the challenge server with <code>localhost</code> as IP.</p>
<p><code>./hyperion_client localhost</code></p>
<h3 id="hyperion---lets-play-by-x3ero0">Hyperion - Let&rsquo;s Play by X3eRo0</h3>
<hr>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/controls.png"
    alt="Game Controls"
    decoding="async"
  />
</div>


<br>

<p>The game has a map of 640x480 pixels or 38400 bytes. Dirt is represented by <code>1</code> and Air is represented by <code>0</code>. We control the Green Tank and Red Tank is the enemy but Red Tank never misses. We have 3 Weapons as described in the above image.</p>
<ul>
<li>18 Damage, 10 Radius Explosion</li>
<li>0 Damage, 15 Radius Dirt Ball</li>
<li>8 Damage, 20 Radius Explosion (Deletes Dirt in its radius)</li>
</ul>
<p>Here is a small and very bad gameplay.


<br>
</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/gameplay.gif"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<h3 id="the-reverse-engineering-starts">The Reverse Engineering Starts</h3>
<hr>
<p>Before starting reversing the code i wanted to look at the network traffic, for that i used wireshark and followed the TCP stream for the packet i found related to the challenge.</p>
<p>This is what the server was sending the client upon receiving the connection</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/server_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>And this is what the client was send to the server after the player fires a bullet.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/client_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>So, from the above 2 images its clear that the server sends the whole map and TANK information to the client and the client renders the MAP and the 2 Tanks based on what information the server sent. The client then sends the bullet information to the server which contains information about weapon, angle and power that the player used to fire at the enemy tank. The server then calculates where this bullet should hit using some basic math and deducts health points and Dirt from the map due to the explosion.</p>
<p>So, now we can start reverse engineering the server binary and look for bugs that we can exploit.</p>
<p>First let&rsquo;s take a look at some functions which the binary uses more frequently than others, these mainly include network functions to send and receive data.</p>
<p>BTW this challenge uses <a href="https://github.com/gynvael/NetSock">NetSock</a> which is a C++ Network Library for both Windows and Linux.</p>
<p>The server binary has <code>SendText</code>, <code>SendMap</code>, <code>SendTank</code>, <code>SendBullet</code> and <code>SendPacket</code> functions, out these SendPacket Wraps the Data to be sent in a C++ string and sends it along with the 32 bit length of the data. So, it first sends the 4 byte header which contains the length of the data to be received by the other party.</p>
<p><code>SendText</code>, <code>SendMap</code>, <code>SendTank</code> and <code>SendBullet</code> just sends their respective data structures to the client socket.</p>
<p>Now let&rsquo;s take a look at the main handler function which handles everything.</p>


<pre>
	<code class="language-c">
		__int64 __fastcall Game(Netsock *c, __int64 some_number, int a3, int a4, int a5, int a6)
{
  int v7; // ecx
  int v8; // er8
  int v9; // er9
  __int64 v10; // rdx
  const char *Message_; // rdx
  const char *Tank_1; // rax
  const char *Tank; // rax
  const char *v14; // rax
  char map[38400]; // [rsp+10h] [rbp-9608h] BYREF

  if ( !SendText(c, "Welcome to Hyperion Tank Game!") )
    return 1LL;
  memset(map, 0, sizeof(map));
  generate_map(map);
LABEL_4:
  AdjustTankPosition(tanks, map);
  AdjustTankPosition(&tanks[1], map);
  if ( !send_map(c, map) || !send_tank(c, tanks) )
    exit(0);
  if ( !unk_208098 )
  {
    cplusplus_string_init(&command_received_by_client);
    unk_208098 = 1;
    _cxa_atexit(func, &command_received_by_client, &dso_handle);
  }
  if ( !RecvClientCommand(c, &command_received_by_client) )
    return 2LL;
  if ( not_cplusplus_string_compare(&command_received_by_client, "FIRE") )
    return 3LL;
  if ( tanks[0].hp <= 0 )
  {
    SendText(c, "Bye.");
    return 0LL;
  }
  t = *array_access_operator(command_received_by_client.data, 0LL);
  if ( t.Weapon != 1 && t.Weapon != 2 && t.Weapon != 3 )
    return 4LL;
  if ( t.Power < 10.0 || t.Power > 100.0 )
    return 5LL;
  if ( t.Angle >= 0.0 && t.Angle <= 180.0 )
  {
    for ( i = 0; ; ++i )
    {
      if ( i > 1 )
        goto LABEL_4;
      if ( !unk_2080D8 )
      {
        sub_2DBA(&bullet_event);
        unk_2080D8 = 1;
        _cxa_atexit(sub_2DD6, &bullet_event, &dso_handle);
      }
      if ( i || tanks[0].hp <= 0 )
      {
        if ( i != 1 || tanks[1].hp <= 0 )
          continue;
        expl = FireTankGunAndCheatHard(map, &bullet_event, &dword_0 + 1, v7, v8, v9);
      }
      else
      {
        *&expl.exploded = FireTankGun(map, &bullet_event, &t, v7, v8);
        *&expl.y = v10;
      }
      if ( SendBullet(c, &bullet_event) != 1 )
        goto LABEL_4;
      tank_hit = 0;
      if ( LOBYTE(expl.exploded) )
      {
        for ( j = 0; j <= 1; ++j )
        {
          if ( tanks[j].hp > 0 )
          {
            dx_ = expl.x - tanks[j].x;
            dy_ = expl.y - tanks[j].y;
            v7 = dy_;
            dist_sq = dx_ * dx_ + dy_ * dy_;
            radius = WEAPON_EXPLOSION_RADIUS[expl.weapon];
            radius_sq = radius * radius;
            if ( dx_ * dx_ + dy_ * dy_ <= radius * radius )
            {
              tank_hit = 1;
              r_half = radius / 2;
              r_half_sq = radius / 2 * (radius / 2);
              damage = WEAPON_EXPLOSION_DMG[expl.weapon];
              if ( dist_sq > radius / 2 * (radius / 2) )
                damage /= 2;
              tanks[j].hp -= damage;
              if ( tanks[j].hp > 0 )
              {
                if ( j )
                  Tank = "RED";
                else
                  Tank = "GREEN";
                sprintf(Message, "%s tank hit for %i damage.", Tank, damage);
                SendText(c, Message);
              }
              else
              {
                tanks[j].hp = 0;
                if ( j )
                  Message_ = " Stay & practice :)";
                else
                  Message_ = " Game Over.";
                if ( j )
                  Tank_1 = "RED";
                else
                  Tank_1 = "GREEN";
                sprintf(s, "%s tank destroyed.%s", Tank_1, Message_);
                SendText(c, s);
              }
            }
          }
        }
      }
      if ( tank_hit != 1 )
      {
        if ( i )
          v14 = "RED";
        else
          v14 = "GREEN";
        sprintf(Message__, "%s tank missed.", v14);
        SendText(c, Message__);
      }
    }
  }
  return 6LL;
}
	</code>
</pre>

<p>Let&rsquo;s disect this into multiple peices that we can go through one by one.</p>
<p>So, first we will look at line</p>

        </div>



        <footer class="post-footer">
                
                
                
        
                
                
                
        </footer>
        
<table cellspacing="15" style="width:100%; border: none;">
    <tr>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
    </tr>
</table>

        
    </article>

    

</main>


        <div class="sidebar1 widgets columns-1">

    <aside>
    
</aside>
    <aside class="widget widget_categories">
        <h2></h2>
        <ul class="widget__list">
        </ul>
    </aside>

    <aside class="widget widget_tag_cloud">
        <h2></h2>
        <div class="tagcloud">
        </div>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2></h2>
        <ul>
        </ul>
    </aside>

    <aside class="widget widget_archive">
        <h2></h2>
        <ul>
        </ul>
    </aside>

</div>
        </div>
        </div>
<footer role="contentinfo" class="document-footer contentinfo widgets columns-1">

    <aside class="widget widget_text">
        <div class="textwidget">
            <p>Â© x3ero0&#39;s blog / Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/tosi29/inkblotty" target="_blank">Inkblotty</a></p>
        </div>
    </aside>
</footer>
</div>

    </body>
</html>
