<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
    <title>Hyperion Writeup - x3ero0&#39;s blog</title>
    <link rel="shortcut icon" href="/img/favicon.ico">
    <style type="text/css">
        img.wp-smiley,
        img.emoji {
            display: inline !important;
            border: none !important;
            box-shadow: none !important;
            height: 1em !important;
            width: 1em !important;
            margin: 0 .07em !important;
            vertical-align: -0.1em !important;
            background: none !important;
            padding: 0 !important;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
    <link rel='stylesheet' href='/css/custom.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/style.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/syntax.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/general.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/toc.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/image.css' type='text/css' media='all' />
</head>

    <body class="two-column">
        <a href="#content">Skip to content</a>
<div class="wrapper">
    <header role="banner" class="banner widgets columns-1">
        <a href="/" rel="home">
            <h1 class="site">x3ero0&#39;s blog</h1>
            <p></p>
        </a>
        <nav role="navigation" aria-label="Primary Navigation">

            <ul class="menu">
                <li class="menu-item "><a class="menu__link" href="/crackmes/">CRACKMES</a></li>
                <li class="menu-item "><a class="menu__link" href="/">HOME</a></li>
                <li class="menu-item "><a class="menu__link" href="/posts/">POSTS</a></li>
            </ul>
            <select onChange="location.href=value;">
                <option value="/crackmes/" class="menu-item menu-item-type-custom menu-item-object-custom" >CRACKMES</option>
                <option value="/" class="menu-item menu-item-type-custom menu-item-object-custom" >HOME</option>
                <option value="/posts/" class="menu-item menu-item-type-custom menu-item-object-custom" >POSTS</option>
            </select>
        </nav>
    </header>

    <br>
    <div style="width: 100%; max-height: 100px; text-align: center;">
       
</div>

    <div class="breadcrumbs">
        
    </div>

        <div id="content" class="content">

<main role="main">
    <article role="article" class="post type-post format-standard hentry">
        <header class="post-header">
            <h1>Hyperion Writeup</h1>
            <div class="post-details">
                <a rel="bookmark">
                    <time datetime="2021-03-26T326:1213:386">2021-03-26</time>
                </a>
				
<span style="float: right;">
    <div id="fb-root" style="height: 100%;"></div>
    
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
    
    <div class="fb-share-button" data-href="https://x3ero0.github.io/posts/hyperion/" data-layout="button_count" data-size="small">
        <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fx3ero0.github.io%2fposts%2fhyperion%2f" class="fb-xfbml-parse-ignore">Share</a>
    </div>
    &nbsp;
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="Hyperion Writeup" data-url="https://x3ero0.github.io/posts/hyperion/" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    &nbsp;
    
</span>

            </div>
        </header>

        <div class="post-content">
            <ul>
<li>Author : <a href="https://gynvael.coldwind.pl/">Gynvael Coldwind</a></li>
<li>Language : C/C++</li>
<li>Upload : May 9th, 2018</li>
<li>Level : I will rate it 8/10</li>
<li>Platform : Server: Linux | Client: Windows/Linux etc.</li>
<li>Files : <a href="https://github.com/google/google-ctf/tree/master/2017/finals/2017-finals-pwn-hyperion/">hyperion</a></li>
<li>Desc : It&rsquo;s 2017, so even single-player games require Internet connection.</li>
</ul>


<br>

<p>Hyperion was one of the pwn challenges from Google CTF 2017 Finals. One day I randomly asked Gynvael (who is the author of this challenge) to give me some CTF challenges. He gave me 3 Revs and 1 Pwn challenges. In the end I solved 2 Revs and 1 Pwn.  I received these challenges in June 2019, I solved the 2 Revs (the 3rd Rev is still unsolved and I still have no clue XD) sometime in 2020 but this Pwn (Hyperion) was still remaining. Just recently I decided that I will take a look and I will solve it finally.</p>
<h3 id="first-look">First Look</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/game.png"
    alt="First look of the Challenge"
    decoding="async"
  />
</div>


<br>

<p>Hyperion is a single player clone of Scorched Tanks, except that it requires internet connection even when playing againts a bot. We are given a server binary that runs on Linux and 2 versions of client, one for windows and one for linux. The client binaries requires SDL2 because the game uses <a href="https://www.libsdl.org/">SDL2 Library</a> for graphics and controls.</p>
<p>The Goal of this challenge is to not only defeat the bot, but to also get a shell on the server. I immediately opened the server binary in IDA Pro.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/main.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>The challenge pops shell if its running in DEBUG environment with &ldquo;HYPERION_ENV_TEST&rdquo; environment variable set. Game also supports fork server mode and single run mode.</p>
<p>I used the single run mode so that I can interact through <code>STDIN</code> and <code>STDOUT</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>socat TCP-LISTEN:1337,reuseaddr,fork exec:./hyperion_server
</code></pre></div><p>Now we can connect to the challenge server with <code>localhost</code> as IP.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>./hyperion_client localhost
</code></pre></div><h3 id="hyperion---lets-play-by-x3ero0">Hyperion - Let&rsquo;s Play by X3eRo0</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/controls.png"
    alt="Game Controls"
    decoding="async"
  />
</div>


<br>

<p>The game has a map of 640x480 pixels or 38400 bytes. Dirt is represented by <code>1</code> and Air is represented by <code>0</code>. We control the Green Tank and Red Tank is the enemy but Red Tank never misses. We have 3 Weapons as described in the above image.</p>
<ul>
<li>1 - 0x12 Damage, 10 Radius Explosion</li>
<li>2 - 0x00 Damage, 15 Radius Dirt Ball</li>
<li>3 - 0x08 Damage, 20 Radius Explosion</li>
</ul>
<p>Here is a small and very bad gameplay.


<br>
</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/gameplay.gif"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<h3 id="the-reverse-engineering-starts">The Reverse Engineering Starts</h3>
<p>Before starting reversing the code I wanted to look at the network traffic, for that I used wireshark and followed the TCP stream for the packet I found related to the challenge.</p>
<p>This is what the server was sending the client upon receiving the connection</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/server_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>And this is what the client was send to the server after the player fires a bullet.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/client_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>So, from the above 2 images its clear that the server sends the whole MAP and TANK information to the client and the client renders the MAP and the 2 Tanks based on what information the server sent. The client then sends the bullet information to the server which contains information about weapon, angle and power that the player used to fire at the enemy tank. The server then calculates where this bullet should hit using some basic math and deducts health points and Dirt from the MAP due to the explosion.</p>
<p>So, now we can start reverse engineering the server binary and look for bugs that we can exploit.</p>
<p>First let&rsquo;s take a look at some functions which the binary uses more frequently than others, these mainly include network functions to send and receive data.</p>
<p>BTW this challenge uses <a href="https://github.com/gynvael/NetSock">NetSock</a> which is a C++ Network Library for both Windows and Linux.</p>
<p>The server binary has <em><strong>SendText</strong></em>, <em><strong>SendMap</strong></em>, <em><strong>SendTank</strong></em>, <em><strong>SendBullet</strong></em> and <em><strong>SendPacket</strong></em> functions, out these SendPacket Wraps the Data to be sent in a C++ string and sends it along with the 32 bit length of the data. So, it first sends the 4 byte header which contains the length of the data to be received by the other party.</p>
<p><em><strong>SendText</strong></em>, <em><strong>SendMap</strong></em>, <em><strong>SendTank</strong></em> and <em><strong>SendBullet</strong></em> just sends their respective data structures to the client socket.</p>
<p>Now let&rsquo;s take a look at the main handler function which handles everything.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">Game</span>(Netsock <span style="color:#ff79c6">*</span>c, <span style="color:#ff79c6">__int64</span> some_number, <span style="color:#8be9fd">int</span> a3, <span style="color:#8be9fd">int</span> a4, <span style="color:#8be9fd">int</span> a5, <span style="color:#8be9fd">int</span> a6)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#8be9fd">int</span> v7; <span style="color:#6272a4">// ecx
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v8; <span style="color:#6272a4">// er8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v9; <span style="color:#6272a4">// er9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v10; <span style="color:#6272a4">// rdx
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>Message_; <span style="color:#6272a4">// rdx
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>Tank_1; <span style="color:#6272a4">// rax
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>Tank; <span style="color:#6272a4">// rax
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>v14; <span style="color:#6272a4">// rax
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">char</span> map[<span style="color:#bd93f9">38400</span>]; <span style="color:#6272a4">// [rsp+10h] [rbp-9608h] BYREF
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>SendText(c, <span style="color:#f1fa8c">&#34;Welcome to Hyperion Tank Game!&#34;</span>) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    memset(map, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">sizeof</span>(map));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    GenerateMap(map);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#8be9fd;font-style:italic">LABEL_4</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    AdjustTankPosition(tanks, map);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    AdjustTankPosition(<span style="color:#ff79c6">&amp;</span>tanks[<span style="color:#bd93f9">1</span>], map);
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>SendMap(c, map) <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">!</span>SendTank(c, tanks) )
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        exit(<span style="color:#bd93f9">0</span>);
</code></pre></div><p>Let&rsquo;s disect this into multiple peices that we can go through one by one.</p>
<p>So, first we will look at line 11 we see that the map has been allocated
on the stack with 38400 ((640 * 480) / 8) bytes of size. It first sends the
welcome text then it generates the map using some random numbers and after that
it Adjusts Tank coordinates onto the map, now it sends the map and the tank
structure to the client. So, let&rsquo;s take a look at the SendMap function.</p>
<p>Before we look at the IDA&rsquo;s decompiled code, I want to mention the networking
code of this game.</p>
<p>The game sends packets of this structure</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#ff79c6">struct</span> Packet {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  std<span style="color:#ff79c6">::</span>string type;  <span style="color:#6272a4">// Use only 4-byte values.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#6272a4"></span>  std<span style="color:#ff79c6">::</span>vector<span style="color:#ff79c6">&lt;</span>uint8_t<span style="color:#ff79c6">&gt;</span> data;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>};
</code></pre></div><p>the <strong>type</strong> string contains the header for identification of what kind of
data are we sending and receiving. Now let&rsquo;s analyse the <strong>SendMap</strong> function, I have included comments from the source code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>_BOOL8 <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">SendMap</span>(Netsock <span style="color:#ff79c6">*</span>socket_stuff, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>map)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>v2; <span style="color:#6272a4">// rax
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"></span>    _BOOL4 v3; <span style="color:#6272a4">// ebx
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/*Packet p; */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    Packet MapPacket; <span style="color:#6272a4">// [rsp+10h] [rbp-48h] BYREF
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v6; <span style="color:#6272a4">// [rsp+48h] [rbp-10h]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#6272a4">/* const size_t data_sz = (MAP_W * (MAP_H + 1)) / 8; */</span>
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">38480LL</span>;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#6272a4">/*p.type = &#34;GMAP&#34;;*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    cplusplus_string_init(<span style="color:#ff79c6">&amp;</span>MapPacket);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    std<span style="color:#ff79c6">::</span>__cxx11<span style="color:#ff79c6">::</span> ... <span style="color:#ff79c6">::</span>operator<span style="color:#ff79c6">=</span>(<span style="color:#ff79c6">&amp;</span>MapPacket, <span style="color:#f1fa8c">&#34;GMAP&#34;</span>); <span style="color:#6272a4">// c++ garbage redacted
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#6272a4">/* p.data.resize(data_sz); */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    resize(MapPacket.data, <span style="color:#bd93f9">0x9650uLL</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    v_first_element <span style="color:#ff79c6">=</span> vector_access_operator(MapPacket.data, <span style="color:#bd93f9">0LL</span>);
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    memcpy(v_first_element, map, <span style="color:#bd93f9">38480uLL</span>);
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    v3 <span style="color:#ff79c6">=</span> SendPacket(socket_stuff, <span style="color:#ff79c6">&amp;</span>MapPacket);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#6272a4">/* destructor */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    func(<span style="color:#ff79c6">&amp;</span>MapPacket);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#ff79c6">return</span> v3;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>}
</code></pre></div><p>The vulnerability here is that the <strong>data_sz</strong> is calculated incorrectly because the correct size should be
(MAP_W * MAP_H) / 8. This function is just giving out all the sensitive pointers on the stack to all the
clients connecting. The leak includes <strong>stack</strong> pointers, <strong>libc</strong> pointers, and <strong>binary</strong> pointers.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/leak.png"
    alt="leaks"
    decoding="async"
  />
</div>
<p>The data contained PIE leak, in fact it&rsquo;s the return address of binary +0x2874, at this point we have all the
information that we need for exploitation but we still haven&rsquo;t found an exploitable vulnerability aside from
this memory leak.</p>
<p>Let&rsquo;s analyse next block of code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>RecvClientCommand(c, <span style="color:#ff79c6">&amp;</span>command_received_by_client) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">2LL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    <span style="color:#ff79c6">if</span> ( cplusplus_string_compare(<span style="color:#ff79c6">&amp;</span>command_received_by_client, <span style="color:#f1fa8c">&#34;FIRE&#34;</span>) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">3LL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    <span style="color:#ff79c6">if</span> ( tanks[<span style="color:#bd93f9">0</span>].hp <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>        SendText(c, <span style="color:#f1fa8c">&#34;Bye.&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>    t <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>array_access_operator(command_received_by_client.data, <span style="color:#bd93f9">0LL</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    <span style="color:#ff79c6">if</span> ( t.Weapon <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&amp;&amp;</span> t.Weapon <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&amp;&amp;</span> t.Weapon <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">3</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">4LL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>    <span style="color:#ff79c6">if</span> ( t.Power <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">10.0</span> <span style="color:#ff79c6">||</span> t.Power <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">100.0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">5LL</span>;
</code></pre></div><p>Here it receives a packet from the client and checks if it&rsquo;s a <strong>FIRE</strong> command, because this
is the only input that we can send to the server as client. Whenever a client fires a bullet
it sends a <strong>FIRE</strong> Packet and a <strong>Bullet</strong> Packet. Then it checks if <strong>Weapon</strong> is a valid
<strong>Weapon</strong> value and if the <strong>Power</strong> and <strong>Angle</strong> are also valid or not.</p>
<p>Now we will look at the Game loop</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#ff79c6">if</span> ( t.Angle <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0.0</span> <span style="color:#ff79c6">&amp;&amp;</span> t.Angle <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">180.0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>{
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; ; <span style="color:#ff79c6">++</span>i ) <span style="color:#6272a4">// Game loop
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#6272a4"></span>    {
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>        <span style="color:#ff79c6">if</span> ( i <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span> )
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>            <span style="color:#ff79c6">goto</span> LABEL_4;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>        <span style="color:#6272a4">/* ... */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>        <span style="color:#ff79c6">if</span> ( i <span style="color:#ff79c6">||</span> tanks[<span style="color:#bd93f9">0</span>].hp <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>        {
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>            <span style="color:#ff79c6">if</span> ( i <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">||</span> tanks[<span style="color:#bd93f9">1</span>].hp <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">0</span> )
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>                <span style="color:#ff79c6">continue</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>            expl <span style="color:#ff79c6">=</span> FireTankGunAndCheatHard(map, <span style="color:#ff79c6">&amp;</span>bullet_event, <span style="color:#ff79c6">&amp;</span>dword_0 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, v7, v8, v9);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>        }
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>        <span style="color:#ff79c6">else</span>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>        {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>            <span style="color:#ff79c6">*&amp;</span>expl.exploded <span style="color:#ff79c6">=</span> FireTankGun(map, <span style="color:#ff79c6">&amp;</span>bullet_event, <span style="color:#ff79c6">&amp;</span>t, v7, v8);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>            <span style="color:#ff79c6">*&amp;</span>expl.y <span style="color:#ff79c6">=</span> v10;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>        <span style="color:#ff79c6">if</span> ( SendBullet(c, <span style="color:#ff79c6">&amp;</span>bullet_event) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>            <span style="color:#ff79c6">goto</span> LABEL_4;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>        <span style="color:#6272a4">/* Explosion related code redacted */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>}
</code></pre></div><p>In the above loop it is doing the calculation related to Firing of bullet.
Here IDA&rsquo;s decompiled code made it a bit hard to realise whats happening.
The highlighted <strong>for-loop</strong> on line <strong>45-47</strong> iterates from <strong>0-1</strong> and
that is because it is iterating over the two tanks for shooting, if <strong>i</strong>
is 1 then <strong>FireTankGunAndCheatHard</strong> function is called because <strong>Red Tank</strong>
is the enemy tank but if <strong>i</strong> is 0, then <strong>FireTankGun</strong> function is called.</p>
<p>Let&rsquo;s see both of these functions, I am using the challenge source code here</p>
<h1 id="1-firetankgun">1. FireTankGun</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>Explosion <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">FireTankGun</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>	<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>map,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>	Bullet <span style="color:#ff79c6">*</span>bullet,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>	TargettingData <span style="color:#ff79c6">*</span>Target,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>	<span style="color:#8be9fd">int</span> x, <span style="color:#8be9fd">int</span> y
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>	<span style="color:#6272a4">/* ... */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>	vx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.01</span> <span style="color:#ff79c6">*</span> Target<span style="color:#ff79c6">-&gt;</span>Power <span style="color:#ff79c6">*</span> cos(<span style="color:#bd93f9">3.14159</span> <span style="color:#ff79c6">*</span> Target<span style="color:#ff79c6">-&gt;</span>Angle <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">180.0</span>);
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>	vy <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.01</span> <span style="color:#ff79c6">*</span> Target<span style="color:#ff79c6">-&gt;</span>Power <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">-</span>sin(<span style="color:#bd93f9">3.14159</span> <span style="color:#ff79c6">*</span> Target<span style="color:#ff79c6">-&gt;</span>Angle <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">180.0</span>);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>	bullet_event_clear(bullet);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>	x_1 <span style="color:#ff79c6">=</span> v6;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>	y_1 <span style="color:#ff79c6">=</span> v7 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">5.0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>	explode <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>	last_ix <span style="color:#ff79c6">=</span> min();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>	last_iy <span style="color:#ff79c6">=</span> min();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>	<span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">9999</span>; <span style="color:#ff79c6">++</span>i )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>	{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>		x_1 <span style="color:#ff79c6">=</span> x_1 <span style="color:#ff79c6">+</span> vx;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>		y_1 <span style="color:#ff79c6">=</span> y_1 <span style="color:#ff79c6">+</span> vy;
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>		vy <span style="color:#ff79c6">=</span> vy <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0.0009807000000000001</span>;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>		ix <span style="color:#ff79c6">=</span> x_1;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>		iy <span style="color:#ff79c6">=</span> y_1;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>		<span style="color:#6272a4">/* ... */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>	<span style="color:#ff79c6">if</span> ( explode )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>	{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>		a2.x <span style="color:#ff79c6">=</span> ix;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>		a2.y <span style="color:#ff79c6">=</span> iy;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>		a2.weapon <span style="color:#ff79c6">=</span> Target<span style="color:#ff79c6">-&gt;</span>Weapon;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>		bullet_event_emplace_back(bullet, <span style="color:#ff79c6">&amp;</span>a2);
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>		ApplyExplosionToMap(map, ix, iy, Target<span style="color:#ff79c6">-&gt;</span>Weapon);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>	LOBYTE(v5) <span style="color:#ff79c6">=</span> explode;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>	<span style="color:#ff79c6">return</span> v5 <span style="color:#ff79c6">|</span> (ix <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">32</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>}
</code></pre></div><p>This function is responsible for projectile shooting of <strong>Green Tank</strong>. The trajectory of bullet is effected by <strong>Gravity</strong> (line 23), <strong>Angle</strong> and <strong>Power</strong> (line 11-12). After calculating the correct coordinate of the Explosion, the explosion effect is applied to the <strong>MAP</strong> (line 34).</p>
<h1 id="2-firetankgunandcheathard">2. FireTankGunAndCheatHard</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>Explosion <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">FireTankGunAndCheatHard</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>	<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>MAP,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>	Bullet <span style="color:#ff79c6">*</span>bullet_event,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>	<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> weapon,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>	<span style="color:#8be9fd">int</span> a4, <span style="color:#8be9fd">int</span> a5, <span style="color:#8be9fd">int</span> a6
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>	<span style="color:#6272a4">/* ... */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>	bullet_event_clear(bullet_event);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>	v17 <span style="color:#ff79c6">=</span> v7;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>	y_1 <span style="color:#ff79c6">=</span> v8 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">5.0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>	explode <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>	<span style="color:#ff79c6">while</span> ( y_1 <span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">20.0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>	{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>		x <span style="color:#ff79c6">=</span> v17;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>		y <span style="color:#ff79c6">=</span> y_1;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>		<span style="color:#ff79c6">if</span> ( y_1 <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&amp;&amp;</span> GetPixel(MAP, x, y) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>		{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>			explode <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>			<span style="color:#ff79c6">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>		}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>		v14.x <span style="color:#ff79c6">=</span> x;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>		v14.y <span style="color:#ff79c6">=</span> y;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>		v14.weapon <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>		bullet_event_emplace_back(bullet_event, <span style="color:#ff79c6">&amp;</span>v14);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>		y_1 <span style="color:#ff79c6">=</span> y_1 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1.5</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>	<span style="color:#6272a4">/* ... */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>	<span style="color:#ff79c6">if</span> ( explode )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>	{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>		x_1.x <span style="color:#ff79c6">=</span> x;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>		x_1.y <span style="color:#ff79c6">=</span> y;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>		x_1.weapon <span style="color:#ff79c6">=</span> weapon;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>		bullet_event_emplace_back(bullet_event, <span style="color:#ff79c6">&amp;</span>x_1);
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>		ApplyExplosionToMap(MAP, x, y, weapon);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>	LOBYTE(v6) <span style="color:#ff79c6">=</span> explode;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>	<span style="color:#ff79c6">*&amp;</span>v12.exploded <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">|</span> (x <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">32</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>	<span style="color:#ff79c6">*&amp;</span>v12.y <span style="color:#ff79c6">=</span> y <span style="color:#ff79c6">|</span> (weapon <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">32</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>	<span style="color:#ff79c6">return</span> v12;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>}
</code></pre></div><p>This function is responsible for <strong>NON-PROJECTILE AIMBOT</strong> shooting of <strong>Red Tank</strong>. The trajectory of bullet shot by <strong>Red Tank</strong> is always fixed on <strong>Green Tank</strong>. The Bullet never misses because it falls straight on <strong>Green Tank</strong>. After calculating the correct coordinate of the Explosion, the explosion effect is applied to the <strong>MAP</strong> (line 36).</p>
<p>Looking at the above functions we know that the <strong>Red Tank</strong> is going to punish us if we miss any of our shots.</p>
<h3 id="the-vulnerability">The Vulnerability</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">ApplyExplosionToMap</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>	<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>map,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>	<span style="color:#8be9fd">int</span> x,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>	<span style="color:#8be9fd">int</span> y,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>	<span style="color:#8be9fd">int</span> weapon
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>	<span style="color:#8be9fd">bool</span> effect; <span style="color:#6272a4">// [rsp+2Ch] [rbp-1Ch]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>	<span style="color:#8be9fd">int</span> r; <span style="color:#6272a4">// [rsp+34h] [rbp-14h]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>	<span style="color:#8be9fd">signed</span> <span style="color:#8be9fd">int</span> j; <span style="color:#6272a4">// [rsp+38h] [rbp-10h]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>	<span style="color:#8be9fd">signed</span> <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+3Ch] [rbp-Ch]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>	r <span style="color:#ff79c6">=</span> WEAPON_EXPLOSION_RADIUS[weapon];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>	effect <span style="color:#ff79c6">=</span> weapon <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">2</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>	<span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> y <span style="color:#ff79c6">-</span> r; y <span style="color:#ff79c6">+</span> r <span style="color:#ff79c6">&gt;=</span> i; <span style="color:#ff79c6">++</span>i )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>	{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>		<span style="color:#ff79c6">for</span> ( j <span style="color:#ff79c6">=</span> x <span style="color:#ff79c6">-</span> r; x <span style="color:#ff79c6">+</span> r <span style="color:#ff79c6">&gt;=</span> j; <span style="color:#ff79c6">++</span>j )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>		{
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>			<span style="color:#ff79c6">if</span> ( (i <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&amp;&amp;</span> i <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">480</span>) <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#6272a4">// Vulnerability
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#6272a4"></span>				 (j <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&amp;&amp;</span> j <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">639</span>) <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>				 ((j <span style="color:#ff79c6">-</span> x) <span style="color:#ff79c6">*</span> (j <span style="color:#ff79c6">-</span> x) <span style="color:#ff79c6">+</span> (i <span style="color:#ff79c6">-</span> y) <span style="color:#ff79c6">*</span> (i <span style="color:#ff79c6">-</span> y) <span style="color:#ff79c6">&lt;=</span> r <span style="color:#ff79c6">*</span> r )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>			   ){
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>				PutPixel(map, j, i, effect);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>			}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>		}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>	<span style="color:#ff79c6">return</span> ApplyGravitationToMap(map, (x <span style="color:#ff79c6">-</span> r), (r <span style="color:#ff79c6">+</span> x));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#6272a4">/* Modifies Colors in MAP at bit level */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">PutPixel</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>	<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>MAP,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>	<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> x,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>	<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> y,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>	<span style="color:#8be9fd">char</span> color
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>	<span style="color:#ff79c6">__int64</span> result; <span style="color:#6272a4">// rax
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#6272a4"></span>	<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> v5; <span style="color:#6272a4">// [rsp+20h] [rbp-4h]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>	<span style="color:#ff79c6">if</span> ( x <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">639</span> <span style="color:#ff79c6">&amp;&amp;</span> y <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">480</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>	{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>		v5 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">640</span> <span style="color:#ff79c6">*</span> y <span style="color:#ff79c6">+</span> x;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>		MAP[v5 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">&amp;=</span> <span style="color:#ff79c6">~</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;&lt;</span> (v5 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">7</span>));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>		result <span style="color:#ff79c6">=</span> MAP[v5 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">3</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>		LOBYTE(result) <span style="color:#ff79c6">=</span> ((color <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">&lt;&lt;</span> (v5 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">7</span>)) <span style="color:#ff79c6">|</span> result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>		MAP[v5 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">=</span> result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>	<span style="color:#ff79c6">return</span> result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>}
</code></pre></div><p>Did you spot the Vulnerability?</p>
<p>The vulnerability here is in the <strong>ApplyExplosionToMap()</strong>. If you see line 20
We can see that the boundary check for <strong>i</strong> is done incorrectly. The boundary
for <strong>i</strong> should&rsquo;ve been <strong>i &gt;= 0 &amp;&amp; i &lt;= 479</strong>, instead it is <strong>i &gt;= 0 &amp;&amp; i &lt;= 480</strong>.</p>
<p>What if an explosion happens at the bottom of the <strong>MAP</strong>?. The explosion will create
an empty circle of Air in the MAP and half of this circle will lie inside the MAP and
half of the circle will corrupt the values which lies after the MAP.</p>
<p>This vulnerability allows us to create explosion effect outside of the MAP, which
means we can manipulate bits outside of the MAP. We know there are important pointers
just after the MAP on the stack, if we can corrupt them we can redirect code execution.</p>
<p>I tried to destroy the ground until I reach the bottom of the <strong>MAP</strong> and now if we
look at the GMAPP leak we will see a lot <strong>NULL</strong> bytes including the part where
we got the return address from, which means we were able to modify the return address
by just exploding the ground.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/hexdump.png"
    alt="Leak after exploding ground"
    decoding="async"
  />
</div>
<h3 id="triggering-the-vulnerability">Triggering The Vulnerability</h3>
<p>Okay, we know that we can manipulate the return address just by doing different kinds
of explosions. Explosion with weapon 1 will remove the dirt in the radius of the explosion
which basically means it will unset the bits in the range of its radius and if we fire
a weapon 2 which is the dirt ball then we will set all the bits in the range of the weapon 2.</p>
<p>Using this primitive we can overwrite the return address with any arbitrary value just by
exploding different weapons, but its not as easy as it sounds. If we start destroying the
ground instead of shooting at the <strong>Red Tank</strong> then the <strong>Red Tank</strong> will immedieatly destroy
us and we won&rsquo;t be able to do anything. We need to figure out a way to defeat the <strong>Red Tank</strong>.</p>
<h3 id="2d-projectile-aimbot">2D Projectile AIMBOT</h3>
<p>Making an aimbot for hyperion was fairly easy because the tanks don&rsquo;t move horizontally.
It&rsquo;s like solving a physics problem to find the correct initial velocity and angle to
hit the target. Since the <strong>Tanks</strong> could be at different height level we can&rsquo;t just use
the basic projectile motion formulas, we need to take account of the height difference.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/projectile.png"
    alt="Projectile"
    decoding="async"
  />
</div>
<p>Let&rsquo;s call the difference of height between both the <strong>Tanks</strong> as <strong>H</strong>, the displacement
between both the <strong>Tanks</strong> as <strong>D</strong>, initial velocity at which the projectile is launched
or in our case the <strong>Power</strong> as <strong>u</strong>, Gravitaional acceleration as <strong>g</strong> and initial launch
angle as <strong>θ</strong> (Theta) then the height of a projectile at any time (t) is given by,</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/height_eq.png"
    alt="equation of height"
    decoding="async"
  />
</div>
<p>We want the projectile to hit the <strong>Red Tank</strong> which is at displacement <strong>D</strong> from the
<strong>Green Tank</strong>. So, the time <strong>t</strong> when the projectile reaches the <strong>Red Tank</strong> will be
given by,</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/time_eq.png"
    alt="Time at the end"
    decoding="async"
  />
</div>
<p>Using both the equations we can derive the expression for initial velocity of launch or
<strong>Power</strong>.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/derivation.png"
    alt="Derivation of initial Velocity"
    decoding="async"
  />
</div>
<p>Using the above expression for the initial velocity we can try a bunch of angles in the
range of 0-90 degrees for which we get initial velocity under 100 because that is our
limit for <strong>Power</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">from</span> math <span style="color:#ff79c6">import</span> sqrt, sin, cos, radians <span style="color:#ff79c6">as</span> rd, degrees <span style="color:#ff79c6">as</span> dg
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">GetAim</span>(d, h):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    g <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">9.8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#ff79c6">for</span> angle <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">90</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        root <span style="color:#ff79c6">=</span> ((g <span style="color:#ff79c6">*</span> d <span style="color:#ff79c6">*</span> d)<span style="color:#ff79c6">/</span><span style="color:#bd93f9">2</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        root <span style="color:#ff79c6">/=</span> (d <span style="color:#ff79c6">*</span> <span style="color:#8be9fd;font-style:italic">abs</span>(sin(rd(angle))) <span style="color:#ff79c6">*</span> cos(rd(angle)) <span style="color:#ff79c6">-</span> h <span style="color:#ff79c6">*</span> (cos(rd(angle)) <span style="color:#ff79c6">**</span> <span style="color:#bd93f9">2</span>))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        power <span style="color:#ff79c6">=</span> sqrt(root)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        angle <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">180</span> <span style="color:#ff79c6">-</span> angle
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        <span style="color:#ff79c6">if</span> power <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">100.0</span> <span style="color:#ff79c6">and</span> power <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">10.0</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            <span style="color:#ff79c6">return</span> power, angle
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">CreateAimbotPacket</span>(tanks):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    xa <span style="color:#ff79c6">=</span> tanks<span style="color:#ff79c6">.</span>tank1<span style="color:#ff79c6">.</span>x
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    xb <span style="color:#ff79c6">=</span> tanks<span style="color:#ff79c6">.</span>tank2<span style="color:#ff79c6">.</span>x
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    ya <span style="color:#ff79c6">=</span> tanks<span style="color:#ff79c6">.</span>tank1<span style="color:#ff79c6">.</span>y
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    yb <span style="color:#ff79c6">=</span> tanks<span style="color:#ff79c6">.</span>tank2<span style="color:#ff79c6">.</span>y
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    d <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">abs</span>(xa <span style="color:#ff79c6">-</span> xb)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    h <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">abs</span>(ya <span style="color:#ff79c6">-</span> yb)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    power, angle <span style="color:#ff79c6">=</span> GetAim(d, h)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;AIM at (</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">)&#34;</span> <span style="color:#ff79c6">%</span> (xb, yb))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;angle: </span><span style="color:#f1fa8c">%f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> angle)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;power: </span><span style="color:#f1fa8c">%f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> power)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#ff79c6">return</span> CreatePacket(<span style="color:#bd93f9">1</span>, power, angle)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">FireAt</span>(weapon, x, y, tanks, debug):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    xa <span style="color:#ff79c6">=</span> tanks<span style="color:#ff79c6">.</span>tank1<span style="color:#ff79c6">.</span>x
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    xb <span style="color:#ff79c6">=</span> x
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    ya <span style="color:#ff79c6">=</span> tanks<span style="color:#ff79c6">.</span>tank1<span style="color:#ff79c6">.</span>y
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    yb <span style="color:#ff79c6">=</span> y
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    d  <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">abs</span>(xa <span style="color:#ff79c6">-</span> xb)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    h  <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">abs</span>(ya <span style="color:#ff79c6">-</span> yb)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    P,A<span style="color:#ff79c6">=</span> GetAim(d, h)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    <span style="color:#ff79c6">if</span> debug:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;AIM at (</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">)&#34;</span> <span style="color:#ff79c6">%</span> (x, y))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;angle: </span><span style="color:#f1fa8c">%f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> A)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>        <span style="color:#ff79c6">print</span>(<span style="color:#f1fa8c">&#34;power: </span><span style="color:#f1fa8c">%f</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">%</span> P)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    <span style="color:#ff79c6">return</span> CreatePacket(weapon, P, A)
</code></pre></div><p>These functions were working fine but eventually we would miss our shot and the other tank hits a bullseye, in this situation we can never kill him because the <strong>MAP</strong> was generated in a way that when we hit him once, he falls in the hole created by the explosion and when we adjust our aim, our bullet collides with a mountain peak instead of colliding with the <strong>Red Tank</strong>. We don&rsquo;t account for any obstruction on the trajectory of the bullet. Sometimes our bullet is obstructed by a mountain or maybe we cannot hit him because of our terrible spawn location, sometimes we spawn at a very steep slope so its not possible to aim at the <strong>Red Tank</strong>. He will keep hitting us and we will always die before him no matter what. So, if we miss even once, we loose the battle and we have to start from scratch and this is what makes this exploit a little unreliable.</p>
<h3 id="the-exploit">The Exploit</h3>
<p>The exploitation is easy now, we have to build a primitive to do manipulate bits arbitrarily on the stack. Using this primitive we can overwrite the return address and redirect code execution. We already have a call to <strong>system(&quot;/bin/sh&rdquo;)</strong> in the executable itself and we also have the <strong>PIE</strong> base address. Using these two values we can get the address where will jump to get code execution.</p>
<p>If we take a look at the code where it checks if the <strong>Red Tank</strong> is alive or dead? we can see that if we defeat the <strong>Red Tank</strong>, then the <strong>MAP</strong> is ours to play with. We can do anything on the <strong>MAP</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>		tanks[j].hp <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span>		<span style="color:#ff79c6">if</span> ( j )
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>		  Message_ <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34; Stay &amp; practice :)&#34;</span>;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>		<span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>		  Message_ <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34; Game Over.&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>		<span style="color:#ff79c6">if</span> ( j )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>		  Tank_1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;RED&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>		<span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>		  Tank_1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;GREEN&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span>		sprintf(s, <span style="color:#f1fa8c">&#34;%s tank destroyed.%s&#34;</span>, Tank_1, Message_);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span>		SendText(c, s);
</code></pre></div><p>Steps to Get the <strong>SHELL</strong>:</p>
<ol>
<li>Use the aimbot to kill <strong>Red Tank</strong></li>
<li>Clear the Ground (clear all the bits on the stack)</li>
<li>Fire Dirt ball and bombs carefully so that we can write bits of the return address</li>
</ol>
<p>But how do we write arbitrary bits with explosions?
We can easily do that by carefully using the <strong>Dirtball</strong> and the <strong>bomb</strong>, for writing a bit <strong>1</strong> at (630, 479) we must fire the <strong>Dirtball</strong> at 630 - dirtball.radius and then we will fire a explosive bomb such that only 1 set bit remains at 630. We can skip writting bit <strong>0</strong> because the <strong>MAP</strong> is already cleared and the bits at that position are already 0.</p>
<h2 id="-cat-flagtxt">$ cat flag.txt</h2>
<p>The exploit is available <a href="https://gist.github.com/X3eRo0/dfbb43660c616cbb03002d83c79c647b">here</a>.</p>


<script id="asciicast-Kjqb3kQTHGzmWUutJl1Txm1LY" src="https://asciinema.org/a/Kjqb3kQTHGzmWUutJl1Txm1LY.js" async></script>
        </div>



        <footer class="post-footer">
                
                
                
                <span class="post-categories">
                        <a href="https://x3ero0.github.io/categories/pwn/">Pwn</a>&emsp;
                        
                </span>
                
        
                
                
                
        </footer>
        
<table cellspacing="15" style="width:100%; border: none;">
    <tr>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
    </tr>
</table>

        
    </article>

    

</main>


        <div class="sidebar1 widgets columns-1">

    <aside>
    
</aside>
    <aside class="widget widget_categories">
        <h2>Categories</h2>
        <ul class="widget__list"><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/crackmes/">Crackmes (7)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/ctf/">CTF (2)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/pwn/">Pwn (3)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/rev/">Rev (5)</a>
            </li>
        </ul>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2>Recent Posts</h2>
        <ul>
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/orxw_balsn_ctf_2021_pwn/">or⊕w writeup from Balsn CTF 2021</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/easy_kernel_exploitation/">Easy_Kernel Writeup from K3RN3LCTF 2021</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hyperion/">Hyperion Writeup</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/float-writeup/">Float Writeup</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hell86_from_ttlhacker/">Hell86 - ttlhacker</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/reversing_a_malware_in_disguise/">Reversing a malware in disguise</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/watevr_repyc/">Watevr_repyc</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hsctf-license/">HSCTF License</a>
                    </li>
                
            
        </ul>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2>Recent Posts</h2>
        <ul>
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/orxw_balsn_ctf_2021_pwn/">or⊕w writeup from Balsn CTF 2021</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/easy_kernel_exploitation/">Easy_Kernel Writeup from K3RN3LCTF 2021</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hyperion/">Hyperion Writeup</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/float-writeup/">Float Writeup</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hell86_from_ttlhacker/">Hell86 - ttlhacker</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/reversing_a_malware_in_disguise/">Reversing a malware in disguise</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/watevr_repyc/">Watevr_repyc</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hsctf-license/">HSCTF License</a>
                    </li>
                
            
        </ul>
    </aside>
</div>
        </div>
        </div>
<footer role="contentinfo" class="document-footer contentinfo widgets columns-1">

    <aside class="widget widget_text">
        <div class="textwidget">
            <p>© x3ero0&#39;s blog</p>
        </div>
    </aside>
</footer>
</div>

    </body>
</html>
