<!DOCTYPE html>
<html lang="en"><head>
	<meta charset="utf-8">
	<meta name="description" content='X3eRo0&#39;s Blog about Reverse Engineering'>
	<meta name="keywords" content='X3eRo0, Reverse, Reverse Engineering, Crackmes, blog'>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="generator" content="Hugo 0.68.3" />
	<link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="/css/custom.css">
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin=anonymous>
	<link rel="stylesheet" type="text/css"  href="/css/ui.css">
	<title>Hyperion</title>
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
	<nav class="navbar text-center sticky-top bg-white mt-2 mb-1">
		<a href='https://x3ero0.github.io/'><span class="btn btn-sm btn-outline-primary">Home</span></a>
		<a href="/crackmes"><span class="btn btn-sm btn-outline-secondary">Crackmes</span></a>
		<a href="/posts"><span class="btn btn-sm btn-outline-success">Blog</span></a>
		<a href="/tags"><span class="btn btn-sm btn-outline-warning">Tags</span></a>
	</nav>
</head>
<body class="line-numbers">
      <div id="content">


	<section class="container text-justified mt-3">
	  <h2 class="text-center mb-4">Hyperion</h2>
	    <div class="text-monospace">
			

<link href="/css/prism.css" rel="stylesheet" />
<script src="/js/prism.js"></script>

<h1 id="pwning-pocket-tanks---hyperion-google-ctf-2017-finals">Pwning Pocket Tanks - Hyperion [Google CTF 2017 Finals]</h1>
<hr>
<ul>
<li>Author : <a href="https://gynvael.coldwind.pl/">Gynvael Coldwind</a></li>
<li>Language : C/C++</li>
<li>Upload : May 9th, 2018</li>
<li>Level : I will rate it 8/10</li>
<li>Platform : Server: Linux | Client: Windows/Linux etc.</li>
<li>Files : <a href="https://crackmes.one/crackme/5bc0fe0033c5d4110a29b296">change the link hyperion</a></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Desc:
  - It&#39;s 2017, so even single-player games require Internet connection.
</code></pre></div><hr>


<br>

<p>Hyperion was one of the pwn challenges from Google CTF 2017 Finals. One day I randomly asked Gynvael (who is the author of this challenge) to give me some CTF challenges. He gave me 3 Revs and 1 Pwn challenges. In the end i solved 2 Revs and 1 Pwn.  I received these challenges in June 2019, but being a noob i was not able to solve any of them. I solved the 2 Revs (the 3rd Rev is still unsolved and i still have no clue XD) sometime in 2020 but this Pwn (Hyperion) was still remaining. Just recently i decided that i will take a look and i will solve it finally.</p>
<h3 id="first-look">First Look</h3>
<hr>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/game.png"
    alt="First look of the Challenge"
    decoding="async"
  />
</div>


<br>

<p>Hyperion is a single player clone of Pocket Tanks, except that it requires internet connection even when playing againts a bot. We are given a server binary that runs on Linux and 2 Version of client, one for windows and one for linux. The client binaries requires SDL2 because the game uses SDL for graphics and controls.</p>
<p>The Goal of this challenge is to not only defeat the bot, but to also get a shell on the server. I immediately opened the server binary in IDA Pro.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/main.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>The challenge pops shell if its running in DEBUG environment with &ldquo;HYPERION_ENV_TEST&rdquo; environment variable set. Game also supports fork server mode and single run mode.</p>
<p>I used the single run mode so that i can the interaction happens through <code>STDIN</code> and <code>STDOUT</code>.</p>
<p><code>socat TCP-LISTEN:1337,reuseaddr,fork exec:./hyperion_server</code></p>
<p>Now we can connect to the challenge server with <code>localhost</code> as IP.</p>
<p><code>./hyperion_client localhost</code></p>
<h3 id="hyperion---lets-play-by-x3ero0">Hyperion - Let&rsquo;s Play by X3eRo0</h3>
<hr>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/controls.png"
    alt="Game Controls"
    decoding="async"
  />
</div>


<br>

<p>The game has a map of 640x480 pixels or 38400 bytes. Dirt is represented by <code>1</code> and Air is represented by <code>0</code>. We control the Green Tank and Red Tank is the enemy but Red Tank never misses. We have 3 Weapons as described in the above image.</p>
<ul>
<li>18 Damage, 10 Radius Explosion</li>
<li>0 Damage, 15 Radius Dirt Ball</li>
<li>8 Damage, 20 Radius Explosion (Deletes Dirt in its radius)</li>
</ul>
<p>Here is a small and very bad gameplay.


<br>
</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/gameplay.gif"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<h3 id="the-reverse-engineering-starts">The Reverse Engineering Starts</h3>
<hr>
<p>Before starting reversing the code i wanted to look at the network traffic, for that i used wireshark and followed the TCP stream for the packet i found related to the challenge.</p>
<p>This is what the server was sending the client upon receiving the connection</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/server_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>And this is what the client was send to the server after the player fires a bullet.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/client_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>So, from the above 2 images its clear that the server sends the whole map and TANK information to the client and the client renders the MAP and the 2 Tanks based on what information the server sent. The client then sends the bullet information to the server which contains information about weapon, angle and power that the player used to fire at the enemy tank. The server then calculates where this bullet should hit using some basic math and deducts health points and Dirt from the map due to the explosion.</p>
<p>So, now we can start reverse engineering the server binary and look for bugs that we can exploit.</p>
<p>First let&rsquo;s take a look at some functions which the binary uses more frequently than others, these mainly include network functions to send and receive data.</p>
<p>BTW this challenge uses <a href="https://github.com/gynvael/NetSock">NetSock</a> which is a C++ Network Library for both Windows and Linux.</p>
<p>The server binary has <code>SendText</code>, <code>SendMap</code>, <code>SendTank</code>, <code>SendBullet</code> and <code>SendPacket</code> functions, out these SendPacket Wraps the Data to be sent in a C++ string and sends it along with the 32 bit length of the data. So, it first sends the 4 byte header which contains the length of the data to be received by the other party.</p>
<p><code>SendText</code>, <code>SendMap</code>, <code>SendTank</code> and <code>SendBullet</code> just sends their respective data structures to the client socket.</p>
<p>Now let&rsquo;s take a look at the main handler function which handles everything.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">
<span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">Game</span>(Netsock <span style="color:#f92672">*</span>c, <span style="color:#66d9ef">__int64</span> some_number, <span style="color:#66d9ef">int</span> a3, <span style="color:#66d9ef">int</span> a4, <span style="color:#66d9ef">int</span> a5, <span style="color:#66d9ef">int</span> a6)
{
  <span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// ecx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v8; <span style="color:#75715e">// er8
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v9; <span style="color:#75715e">// er9
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v10; <span style="color:#75715e">// rdx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>Message_; <span style="color:#75715e">// rdx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>Tank_1; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>Tank; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v14; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> map[<span style="color:#ae81ff">38400</span>]; <span style="color:#75715e">// [rsp+10h] [rbp-9608h] BYREF
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>SendText(c, <span style="color:#e6db74">&#34;Welcome to Hyperion Tank Game!&#34;</span>) )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
  memset(map, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(map));
  generate_map(map);
LABEL_4:
  AdjustTankPosition(tanks, map);
  AdjustTankPosition(<span style="color:#f92672">&amp;</span>tanks[<span style="color:#ae81ff">1</span>], map);
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>send_map(c, map) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>send_tank(c, tanks) )
    exit(<span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>unk_208098 )
  {
    cplusplus_string_init(<span style="color:#f92672">&amp;</span>command_received_by_client);
    unk_208098 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    _cxa_atexit(func, <span style="color:#f92672">&amp;</span>command_received_by_client, <span style="color:#f92672">&amp;</span>dso_handle);
  }
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>RecvClientCommand(c, <span style="color:#f92672">&amp;</span>command_received_by_client) )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2LL</span>;
  <span style="color:#66d9ef">if</span> ( not_cplusplus_string_compare(<span style="color:#f92672">&amp;</span>command_received_by_client, <span style="color:#e6db74">&#34;FIRE&#34;</span>) )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3LL</span>;
  <span style="color:#66d9ef">if</span> ( tanks[<span style="color:#ae81ff">0</span>].hp <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> )
  {
    SendText(c, <span style="color:#e6db74">&#34;Bye.&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
  }
  t <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>array_access_operator(command_received_by_client.data, <span style="color:#ae81ff">0LL</span>);
  <span style="color:#66d9ef">if</span> ( t.Weapon <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> t.Weapon <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span> t.Weapon <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">4LL</span>;
  <span style="color:#66d9ef">if</span> ( t.Power <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10.0</span> <span style="color:#f92672">||</span> t.Power <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100.0</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">5LL</span>;
  <span style="color:#66d9ef">if</span> ( t.Angle <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.0</span> <span style="color:#f92672">&amp;&amp;</span> t.Angle <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">180.0</span> )
  {
    <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; ; <span style="color:#f92672">++</span>i )
    {
      <span style="color:#66d9ef">if</span> ( i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> )
        <span style="color:#66d9ef">goto</span> LABEL_4;
      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>unk_2080D8 )
      {
        sub_2DBA(<span style="color:#f92672">&amp;</span>bullet_event);
        unk_2080D8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        _cxa_atexit(sub_2DD6, <span style="color:#f92672">&amp;</span>bullet_event, <span style="color:#f92672">&amp;</span>dso_handle);
      }
      <span style="color:#66d9ef">if</span> ( i <span style="color:#f92672">||</span> tanks[<span style="color:#ae81ff">0</span>].hp <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> )
      {
        <span style="color:#66d9ef">if</span> ( i <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> tanks[<span style="color:#ae81ff">1</span>].hp <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> )
          <span style="color:#66d9ef">continue</span>;
        expl <span style="color:#f92672">=</span> FireTankGunAndCheatHard(map, <span style="color:#f92672">&amp;</span>bullet_event, <span style="color:#f92672">&amp;</span>dword_0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, v7, v8, v9);
      }
      <span style="color:#66d9ef">else</span>
      {
        <span style="color:#f92672">*&amp;</span>expl.exploded <span style="color:#f92672">=</span> FireTankGun(map, <span style="color:#f92672">&amp;</span>bullet_event, <span style="color:#f92672">&amp;</span>t, v7, v8);
        <span style="color:#f92672">*&amp;</span>expl.y <span style="color:#f92672">=</span> v10;
      }
      <span style="color:#66d9ef">if</span> ( SendBullet(c, <span style="color:#f92672">&amp;</span>bullet_event) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> )
        <span style="color:#66d9ef">goto</span> LABEL_4;
      tank_hit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      <span style="color:#66d9ef">if</span> ( LOBYTE(expl.exploded) )
      {
        <span style="color:#66d9ef">for</span> ( j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>; <span style="color:#f92672">++</span>j )
        {
          <span style="color:#66d9ef">if</span> ( tanks[j].hp <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> )
          {
            dx_ <span style="color:#f92672">=</span> expl.x <span style="color:#f92672">-</span> tanks[j].x;
            dy_ <span style="color:#f92672">=</span> expl.y <span style="color:#f92672">-</span> tanks[j].y;
            v7 <span style="color:#f92672">=</span> dy_;
            dist_sq <span style="color:#f92672">=</span> dx_ <span style="color:#f92672">*</span> dx_ <span style="color:#f92672">+</span> dy_ <span style="color:#f92672">*</span> dy_;
            radius <span style="color:#f92672">=</span> WEAPON_EXPLOSION_RADIUS[expl.weapon];
            radius_sq <span style="color:#f92672">=</span> radius <span style="color:#f92672">*</span> radius;
            <span style="color:#66d9ef">if</span> ( dx_ <span style="color:#f92672">*</span> dx_ <span style="color:#f92672">+</span> dy_ <span style="color:#f92672">*</span> dy_ <span style="color:#f92672">&lt;=</span> radius <span style="color:#f92672">*</span> radius )
            {
              tank_hit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
              r_half <span style="color:#f92672">=</span> radius <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
              r_half_sq <span style="color:#f92672">=</span> radius <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (radius <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>);
              damage <span style="color:#f92672">=</span> WEAPON_EXPLOSION_DMG[expl.weapon];
              <span style="color:#66d9ef">if</span> ( dist_sq <span style="color:#f92672">&gt;</span> radius <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (radius <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>) )
                damage <span style="color:#f92672">/=</span> <span style="color:#ae81ff">2</span>;
              tanks[j].hp <span style="color:#f92672">-=</span> damage;
              <span style="color:#66d9ef">if</span> ( tanks[j].hp <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> )
              {
                <span style="color:#66d9ef">if</span> ( j )
                  Tank <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;RED&#34;</span>;
                <span style="color:#66d9ef">else</span>
                  Tank <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GREEN&#34;</span>;
                sprintf(Message, <span style="color:#e6db74">&#34;%s tank hit for %i damage.&#34;</span>, Tank, damage);
                SendText(c, Message);
              }
              <span style="color:#66d9ef">else</span>
              {
                tanks[j].hp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">if</span> ( j )
                  Message_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; Stay &amp; practice :)&#34;</span>;
                <span style="color:#66d9ef">else</span>
                  Message_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; Game Over.&#34;</span>;
                <span style="color:#66d9ef">if</span> ( j )
                  Tank_1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;RED&#34;</span>;
                <span style="color:#66d9ef">else</span>
                  Tank_1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GREEN&#34;</span>;
                sprintf(s, <span style="color:#e6db74">&#34;%s tank destroyed.%s&#34;</span>, Tank_1, Message_);
                SendText(c, s);
              }
            }
          }
        }
      }
      <span style="color:#66d9ef">if</span> ( tank_hit <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> )
      {
        <span style="color:#66d9ef">if</span> ( i )
          v14 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;RED&#34;</span>;
        <span style="color:#66d9ef">else</span>
          v14 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GREEN&#34;</span>;
        sprintf(Message__, <span style="color:#e6db74">&#34;%s tank missed.&#34;</span>, v14);
        SendText(c, Message__);
      }
    }
  }
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">6LL</span>;
}
</code></pre></div><p>Let&rsquo;s disect this into multiple peices that we can go through one by one.</p>
<p>So, first we will look at line</p>

		</div>
	</section>
<div id="disqus_thread" class="container"></div>
<script>
	(function() { 
		var d = document, s = d.createElement('script');
		s.src = 'https://x3ero0-tech.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            


      </div>
  </body><footer>
  <div class="container-fluid bg-dark text-white text-monospace text-center mt-4">
    <small style="color:#ffffff">
    	<b>-=[ </b>
    	<a href="https://youtube.com/pulkitsinghaniapulkittech" style="color:#e6ffff">YouTube</a>
    	<a href="https://www.linkedin.com/in/pulkit-singh-singaria-500a53166/" style="color:#e6ffff">LinkedIn</a>
    	<a href="https://twitter.com/X3eRo0" style="color:#e6ffff">Twitter</a>
    	<a href="https://ctftime.org/user/43759" style="color:#e6ffff">CTFTime</a>
    	<b> ]=-</b>
    </small>
  </div>
</footer></html>
