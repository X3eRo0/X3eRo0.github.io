<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
    <title>Hyperion - X3eRo0&#39;s Blog about Reverse Engineering</title>

    <style type="text/css">
        img.wp-smiley,
        img.emoji {
            display: inline !important;
            border: none !important;
            box-shadow: none !important;
            height: 1em !important;
            width: 1em !important;
            margin: 0 .07em !important;
            vertical-align: -0.1em !important;
            background: none !important;
            padding: 0 !important;
        }
    </style>
    <link rel='stylesheet' href='/css/style.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/custom.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/syntax.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/general.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/toc.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/image.css' type='text/css' media='all' />
</head>

    <body class="two-column">
        <a href="#content">Skip to content</a>
<div class="wrapper">
    <header role="banner" class="banner widgets columns-1">
        <a href="/" rel="home">
            <h1 class="site">X3eRo0&#39;s Blog about Reverse Engineering</h1>
            <p></p>
        </a>
        <nav role="navigation" aria-label="Primary Navigation">

            <ul class="menu">
                <li class="menu-item "><a class="menu__link" href="/about/">ABOUT</a></li>
                <li class="menu-item "><a class="menu__link" href="/crackmes/">CRACKMES</a></li>
                <li class="menu-item "><a class="menu__link" href="/posts/">POSTS</a></li>
            </ul>
            <select onChange="location.href=value;">
                <option value="/about/" class="menu-item menu-item-type-custom menu-item-object-custom" >ABOUT</option>
                <option value="/crackmes/" class="menu-item menu-item-type-custom menu-item-object-custom" >CRACKMES</option>
                <option value="/posts/" class="menu-item menu-item-type-custom menu-item-object-custom" >POSTS</option>
            </select>
        </nav>
    </header>

    <br>
    <div style="width: 100%; max-height: 100px; text-align: center;">
       
</div>

    <div class="breadcrumbs">
        
    </div>
        <div id="content" class="content">

<main role="main">
    <article role="article" class="post type-post format-standard hentry">
        <header class="post-header">
            <h1>Hyperion</h1>
            <div class="post-details">
                <a rel="bookmark">
                    <time datetime="2021-03-26T326:1213:386">2021-03-26</time>
                </a>
				
<span style="float: right;">
    <div id="fb-root" style="height: 100%;"></div>
    
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
    
    <div class="fb-share-button" data-href="https://x3ero0.github.io/posts/hyperion/" data-layout="button_count" data-size="small">
        <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fx3ero0.github.io%2fposts%2fhyperion%2f" class="fb-xfbml-parse-ignore">Share</a>
    </div>
    &nbsp;
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="Hyperion" data-url="https://x3ero0.github.io/posts/hyperion/" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    &nbsp;
    
</span>

            </div>
        </header>

        <div class="post-content">
            <h1 id="pwning-pocket-tanks---hyperion-google-ctf-2017-finals">Pwning Pocket Tanks - Hyperion [Google CTF 2017 Finals]</h1>
<ul>
<li>Author : <a href="https://gynvael.coldwind.pl/">Gynvael Coldwind</a></li>
<li>Language : C/C++</li>
<li>Upload : May 9th, 2018</li>
<li>Level : I will rate it 8/10</li>
<li>Platform : Server: Linux | Client: Windows/Linux etc.</li>
<li>Files : <a href="https://crackmes.one/crackme/5bc0fe0033c5d4110a29b296">change the link hyperion</a></li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Desc:
  - It&#39;s 2017, so even single-player games require Internet connection.
</code></pre></td></tr></table>
</div>
</div>

<br>

<p>Hyperion was one of the pwn challenges from Google CTF 2017 Finals. One day I randomly asked Gynvael (who is the author of this challenge) to give me some CTF challenges. He gave me 3 Revs and 1 Pwn challenges. In the end i solved 2 Revs and 1 Pwn.  I received these challenges in June 2019, I solved the 2 Revs (the 3rd Rev is still unsolved and I still have no clue XD) sometime in 2020 but this Pwn (Hyperion) was still remaining. Just recently I decided that I will take a look and I will solve it finally.</p>
<h3 id="first-look">First Look</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/game.png"
    alt="First look of the Challenge"
    decoding="async"
  />
</div>


<br>

<p>Hyperion is a single player clone of Pocket Tanks, except that it requires internet connection even when playing againts a bot. We are given a server binary that runs on Linux and 2 Version of client, one for windows and one for linux. The client binaries requires SDL2 because the game uses <a href="https://www.libsdl.org/">SDL2 Library</a> for graphics and controls.</p>
<p>The Goal of this challenge is to not only defeat the bot, but to also get a shell on the server. I immediately opened the server binary in IDA Pro.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/main.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>The challenge pops shell if its running in DEBUG environment with &ldquo;HYPERION_ENV_TEST&rdquo; environment variable set. Game also supports fork server mode and single run mode.</p>
<p>I used the single run mode so that i can the interaction happens through <code>STDIN</code> and <code>STDOUT</code>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">socat TCP-LISTEN:1337,reuseaddr,fork exec:./hyperion_server
</code></pre></td></tr></table>
</div>
</div><p>Now we can connect to the challenge server with <code>localhost</code> as IP.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">./hyperion_client localhost
</code></pre></td></tr></table>
</div>
</div><h3 id="hyperion---lets-play-by-x3ero0">Hyperion - Let&rsquo;s Play by X3eRo0</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/controls.png"
    alt="Game Controls"
    decoding="async"
  />
</div>


<br>

<p>The game has a map of 640x480 pixels or 38400 bytes. Dirt is represented by <code>1</code> and Air is represented by <code>0</code>. We control the Green Tank and Red Tank is the enemy but Red Tank never misses. We have 3 Weapons as described in the above image.</p>
<ul>
<li>1 - 0x12 Damage, 10 Radius Explosion</li>
<li>2 - 0x00 Damage, 15 Radius Dirt Ball</li>
<li>3 - 0x08 Damage, 20 Radius Explosion</li>
</ul>
<p>Here is a small and very bad gameplay.


<br>
</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/gameplay.gif"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<h3 id="the-reverse-engineering-starts">The Reverse Engineering Starts</h3>
<p>Before starting reversing the code i wanted to look at the network traffic, for that i used wireshark and followed the TCP stream for the packet i found related to the challenge.</p>
<p>This is what the server was sending the client upon receiving the connection</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/server_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>And this is what the client was send to the server after the player fires a bullet.</p>


<br>




<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/client_data.png"
    alt="main()"
    decoding="async"
  />
</div>


<br>

<p>So, from the above 2 images its clear that the server sends the whole MAP and TANK information to the client and the client renders the MAP and the 2 Tanks based on what information the server sent. The client then sends the bullet information to the server which contains information about weapon, angle and power that the player used to fire at the enemy tank. The server then calculates where this bullet should hit using some basic math and deducts health points and Dirt from the MAP due to the explosion.</p>
<p>So, now we can start reverse engineering the server binary and look for bugs that we can exploit.</p>
<p>First let&rsquo;s take a look at some functions which the binary uses more frequently than others, these mainly include network functions to send and receive data.</p>
<p>BTW this challenge uses <a href="https://github.com/gynvael/NetSock">NetSock</a> which is a C++ Network Library for both Windows and Linux.</p>
<p>The server binary has <em><strong>SendText</strong></em>, <em><strong>SendMap</strong></em>, <em><strong>SendTank</strong></em>, <em><strong>SendBullet</strong></em> and <em><strong>SendPacket</strong></em> functions, out these SendPacket Wraps the Data to be sent in a C++ string and sends it along with the 32 bit length of the data. So, it first sends the 4 byte header which contains the length of the data to be received by the other party.</p>
<p><em><strong>SendText</strong></em>, <em><strong>SendMap</strong></em>, <em><strong>SendTank</strong></em> and <em><strong>SendBullet</strong></em> just sends their respective data structures to the client socket.</p>
<p>Now let&rsquo;s take a look at the main handler function which handles everything.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">Game</span>(Netsock <span style="color:#ff79c6">*</span>c, <span style="color:#ff79c6">__int64</span> some_number, <span style="color:#8be9fd">int</span> a3, <span style="color:#8be9fd">int</span> a4, <span style="color:#8be9fd">int</span> a5, <span style="color:#8be9fd">int</span> a6)
{
    <span style="color:#8be9fd">int</span> v7; <span style="color:#6272a4">// ecx
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v8; <span style="color:#6272a4">// er8
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v9; <span style="color:#6272a4">// er9
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v10; <span style="color:#6272a4">// rdx
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>Message_; <span style="color:#6272a4">// rdx
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>Tank_1; <span style="color:#6272a4">// rax
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>Tank; <span style="color:#6272a4">// rax
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>v14; <span style="color:#6272a4">// rax
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="color:#6272a4"></span>    <span style="color:#8be9fd">char</span> map[<span style="color:#bd93f9">38400</span>]; <span style="color:#6272a4">// [rsp+10h] [rbp-9608h] BYREF
</span></span><span style="color:#6272a4"></span>
    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>SendText(c, <span style="color:#f1fa8c">&#34;Welcome to Hyperion Tank Game!&#34;</span>) )
        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
    memset(map, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">sizeof</span>(map));
    GenerateMap(map);
    <span style="color:#8be9fd;font-style:italic">LABEL_4</span>:
    AdjustTankPosition(tanks, map);
    AdjustTankPosition(<span style="color:#ff79c6">&amp;</span>tanks[<span style="color:#bd93f9">1</span>], map);
<span style="display:block;width:100%;background-color:#3d3f4a">    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>SendMap(c, map) <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">!</span>SendTank(c, tanks) )
</span>        exit(<span style="color:#bd93f9">0</span>);
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s disect this into multiple peices that we can go through one by one.</p>
<p>So, first we will look at line 11 we see that the map has been allocated
on the stack with 38400 ((640 * 480) / 8) bytes of size. It first sends the
welcome text then it generates the map using some random numbers and after that
it Adjusts Tank coordinates onto the map, now it sends the map and the tank
structure to the client. So, let&rsquo;s take a look at the SendMap function.</p>
<p>Before we look at the IDA&rsquo;s decompiled code, i want to mention the networking
code of this game.</p>
<p>The game sends packets of this structure</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#ff79c6">struct</span> Packet {
  std<span style="color:#ff79c6">::</span>string type;  <span style="color:#6272a4">// Use only 4-byte values.
</span><span style="color:#6272a4"></span>  std<span style="color:#ff79c6">::</span>vector<span style="color:#ff79c6">&lt;</span>uint8_t<span style="color:#ff79c6">&gt;</span> data;
};
</code></pre></td></tr></table>
</div>
</div><p>the <strong>type</strong> string contains the header for identification of what kind of
data are we sending and receiving. Now let&rsquo;s analyse the <strong>SendMap</strong> function, i have included comments from the source code.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">_BOOL8 <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">SendMap</span>(Netsock <span style="color:#ff79c6">*</span>socket_stuff, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>map)
{
    <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>v2; <span style="color:#6272a4">// rax
</span><span style="color:#6272a4"></span>    _BOOL4 v3; <span style="color:#6272a4">// ebx
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/*Packet p; */</span>
    Packet MapPacket; <span style="color:#6272a4">// [rsp+10h] [rbp-48h] BYREF
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v6; <span style="color:#6272a4">// [rsp+48h] [rbp-10h]
</span><span style="color:#6272a4"></span>
    <span style="color:#6272a4">/* const size_t data_sz = (MAP_W * (MAP_H + 1)) / 8; */</span>
<span style="display:block;width:100%;background-color:#3d3f4a">    v6 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">38480LL</span>;
</span>    <span style="color:#6272a4">/*p.type = &#34;GMAP&#34;;*/</span>
    cplusplus_string_init(<span style="color:#ff79c6">&amp;</span>MapPacket);
    std<span style="color:#ff79c6">::</span>__cxx11<span style="color:#ff79c6">::</span> ... <span style="color:#ff79c6">::</span>operator<span style="color:#ff79c6">=</span>(<span style="color:#ff79c6">&amp;</span>MapPacket, <span style="color:#f1fa8c">&#34;GMAP&#34;</span>); <span style="color:#6272a4">// c++ garbage redacted
</span><span style="color:#6272a4"></span>
    <span style="color:#6272a4">/* p.data.resize(data_sz); */</span>
    resize(MapPacket.data, <span style="color:#bd93f9">0x9650uLL</span>);
    v_first_element <span style="color:#ff79c6">=</span> vector_access_operator(MapPacket.data, <span style="color:#bd93f9">0LL</span>);
<span style="display:block;width:100%;background-color:#3d3f4a">    memcpy(v_first_element, map, <span style="color:#bd93f9">38480uLL</span>);
</span><span style="display:block;width:100%;background-color:#3d3f4a">    v3 <span style="color:#ff79c6">=</span> SendPacket(socket_stuff, <span style="color:#ff79c6">&amp;</span>MapPacket);
</span>    <span style="color:#6272a4">/* destructor */</span>
    func(<span style="color:#ff79c6">&amp;</span>MapPacket);
    <span style="color:#ff79c6">return</span> v3;
}
</code></pre></td></tr></table>
</div>
</div><p>The vulnerability here is that the <strong>data_sz</strong> is calculated incorrectly because the correct size should be
(MAP_W * MAP_H) / 8. This function is just giving out all the sensitive pointers on the stack to all the
clients connecting. The leak includes <strong>stack</strong> pointers, <strong>libc</strong> pointers, and <strong>binary</strong> pointers.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/hyperion/leak.png"
    alt="leaks"
    decoding="async"
  />
</div>
<p>The data contained PIE leak, in fact it&rsquo;s the return address of binary +0x2874, at this point we have all the
information that we need for exploitation but we still haven&rsquo;t found an exploitable vulnerability aside from
this memory leak.</p>
<p>Let&rsquo;s analyse next block of code.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>RecvClientCommand(c, <span style="color:#ff79c6">&amp;</span>command_received_by_client) )
        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">2LL</span>;
    <span style="color:#ff79c6">if</span> ( not_cplusplus_string_compare(<span style="color:#ff79c6">&amp;</span>command_received_by_client, <span style="color:#f1fa8c">&#34;FIRE&#34;</span>) )
        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">3LL</span>;
    <span style="color:#ff79c6">if</span> ( tanks[<span style="color:#bd93f9">0</span>].hp <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">0</span> )
    {
        SendText(c, <span style="color:#f1fa8c">&#34;Bye.&#34;</span>);
        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
    }
</code></pre></td></tr></table>
</div>
</div>
        </div>



        <footer class="post-footer">
                
                
                
                <span class="post-categories">
                        <a href="https://x3ero0.github.io/categories/pwn/">Pwn</a>&emsp;
                        
                </span>
                
        
                
                
                
        </footer>
        
<table cellspacing="15" style="width:100%; border: none;">
    <tr>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
    </tr>
</table>

        
    </article>

    

</main>


        <div class="sidebar1 widgets columns-1">

    <aside>
    
</aside>
    <aside class="widget widget_categories">
        <h2>Categories</h2>
        <ul class="widget__list"><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/crackmes/">Crackmes (7)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/ctf/">CTF (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/pwn/">Pwn (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/rev/">Rev (5)</a>
            </li>
        </ul>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2>Recent Posts</h2>
        <ul>
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hyperion/">Hyperion</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/float-writeup/">Float Writeup</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hell86_from_ttlhacker/">Hell86 - ttlhacker</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/reversing_a_malware_in_disguise/">Reversing a malware in disguise</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/watevr_repyc/">Watevr_repyc</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hsctf-license/">HSCTF License</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/plaintext_attack_on_zip_legacy_crypto/">Plaintext Attack on Zip</a>
                    </li>
                
            
        </ul>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2>Recent Posts</h2>
        <ul>
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hyperion/">Hyperion</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/float-writeup/">Float Writeup</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hell86_from_ttlhacker/">Hell86 - ttlhacker</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/reversing_a_malware_in_disguise/">Reversing a malware in disguise</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/watevr_repyc/">Watevr_repyc</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hsctf-license/">HSCTF License</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/plaintext_attack_on_zip_legacy_crypto/">Plaintext Attack on Zip</a>
                    </li>
                
            
        </ul>
    </aside>
</div>
        </div>
        </div>
<footer role="contentinfo" class="document-footer contentinfo widgets columns-1">

    <aside class="widget widget_text">
        <div class="textwidget">
            <p>© X3eRo0&#39;s Blog about Reverse Engineering</p>
        </div>
    </aside>
</footer>
</div>

    </body>
</html>
